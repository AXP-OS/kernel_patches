From ed1213b196397196239574a982e40f4a867d4be4 Mon Sep 17 00:00:00 2001
From: Liam Mark <lmark@codeaurora.org>
Date: Wed, 12 Oct 2016 14:22:56 -0700
Subject: [PATCH] ion: disable system contig heap

A malicious application can take advantage of the ION contig heap to
create a specific memory chunk size to exercise a rowhammer attack on the
physical hardware.
So remove support for the ION contig heap.

Change-Id: I4faa1314e7371ec6327a5d8acf2c8b39cce4be59
Signed-off-by: Liam Mark <lmark@codeaurora.org>
Signed-off-by: Prakash Gupta <guptap@codeaurora.org>
CVE-2016-6728
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>
---
 arch/arm/boot/dts/apq8084-ion.dtsi                 | 5 -----
 arch/arm/boot/dts/mpq8092-ion.dtsi                 | 6 ------
 arch/arm/boot/dts/msm8226-ion.dtsi                 | 5 -----
 arch/arm/boot/dts/msm8226/apq8084-ion.dtsi         | 5 -----
 arch/arm/boot/dts/msm8226/mpq8092-ion.dtsi         | 6 ------
 arch/arm/boot/dts/msm8226/msm8226-ion.dtsi         | 5 -----
 arch/arm/boot/dts/msm8226/msm8610-ion.dtsi         | 5 -----
 arch/arm/boot/dts/msm8226/msm8974-ion.dtsi         | 5 -----
 arch/arm/boot/dts/msm8226/msmsamarium-ion.dtsi     | 5 -----
 arch/arm/boot/dts/msm8610-ion.dtsi                 | 5 -----
 arch/arm/boot/dts/msm8610/msm8610-ion.dtsi         | 5 -----
 arch/arm/boot/dts/msm8974-ion.dtsi                 | 5 -----
 arch/arm/boot/dts/msm8974/apq8084-ion.dtsi         | 5 -----
 arch/arm/boot/dts/msm8974/mpq8092-ion.dtsi         | 6 ------
 arch/arm/boot/dts/msm8974/msm8226-ion.dtsi         | 5 -----
 arch/arm/boot/dts/msm8974/msm8610-ion.dtsi         | 5 -----
 arch/arm/boot/dts/msm8974/msmsamarium-ion.dtsi     | 5 -----
 arch/arm/boot/dts/msm8974pro/apq8084-ion.dtsi      | 5 -----
 arch/arm/boot/dts/msm8974pro/core/msm8974-ion.dtsi | 5 -----
 arch/arm/boot/dts/msm8974pro/mpq8092-ion.dtsi      | 6 ------
 arch/arm/boot/dts/msm8974pro/msm8226-ion.dtsi      | 5 -----
 arch/arm/boot/dts/msm8974pro/msm8610-ion.dtsi      | 5 -----
 arch/arm/boot/dts/msm8974pro/msm8974-ion.dtsi      | 5 -----
 arch/arm/boot/dts/msm8974pro/msmsamarium-ion.dtsi  | 5 -----
 arch/arm/boot/dts/msmsamarium-ion.dtsi             | 5 -----
 drivers/gpu/ion/ion_heap.c                         | 2 +-
 26 files changed, 1 insertion(+), 130 deletions(-)

diff --git a/arch/arm/boot/dts/apq8084-ion.dtsi b/arch/arm/boot/dts/apq8084-ion.dtsi
index 167b8b73ebc..90f49cbf964 100644
--- a/arch/arm/boot/dts/apq8084-ion.dtsi
+++ b/arch/arm/boot/dts/apq8084-ion.dtsi
@@ -20,10 +20,5 @@
 			reg = <25>;
 			qcom,ion-heap-type = "SYSTEM";
 		};
-
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
 	};
 };
diff --git a/arch/arm/boot/dts/mpq8092-ion.dtsi b/arch/arm/boot/dts/mpq8092-ion.dtsi
index 903610d4eb5..c9508b5e7ce 100644
--- a/arch/arm/boot/dts/mpq8092-ion.dtsi
+++ b/arch/arm/boot/dts/mpq8092-ion.dtsi
@@ -20,12 +20,6 @@
 			reg = <25>;
 			qcom,ion-heap-type = "SYSTEM";
 		};
-
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 	};
 };
 
diff --git a/arch/arm/boot/dts/msm8226-ion.dtsi b/arch/arm/boot/dts/msm8226-ion.dtsi
index 443334e4d58..03677f32b73 100644
--- a/arch/arm/boot/dts/msm8226-ion.dtsi
+++ b/arch/arm/boot/dts/msm8226-ion.dtsi
@@ -21,11 +21,6 @@
 			qcom,ion-heap-type = "SYSTEM";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@8 { /* CP_MM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <8>;
diff --git a/arch/arm/boot/dts/msm8226/apq8084-ion.dtsi b/arch/arm/boot/dts/msm8226/apq8084-ion.dtsi
index 167b8b73ebc..90f49cbf964 100644
--- a/arch/arm/boot/dts/msm8226/apq8084-ion.dtsi
+++ b/arch/arm/boot/dts/msm8226/apq8084-ion.dtsi
@@ -20,10 +20,5 @@
 			reg = <25>;
 			qcom,ion-heap-type = "SYSTEM";
 		};
-
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
 	};
 };
diff --git a/arch/arm/boot/dts/msm8226/mpq8092-ion.dtsi b/arch/arm/boot/dts/msm8226/mpq8092-ion.dtsi
index 903610d4eb5..c9508b5e7ce 100644
--- a/arch/arm/boot/dts/msm8226/mpq8092-ion.dtsi
+++ b/arch/arm/boot/dts/msm8226/mpq8092-ion.dtsi
@@ -20,12 +20,6 @@
 			reg = <25>;
 			qcom,ion-heap-type = "SYSTEM";
 		};
-
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 	};
 };
 
diff --git a/arch/arm/boot/dts/msm8226/msm8226-ion.dtsi b/arch/arm/boot/dts/msm8226/msm8226-ion.dtsi
index 323359648b6..4d1b3bbdf00 100644
--- a/arch/arm/boot/dts/msm8226/msm8226-ion.dtsi
+++ b/arch/arm/boot/dts/msm8226/msm8226-ion.dtsi
@@ -26,11 +26,6 @@
 			qcom,ion-heap-type = "IOMMUCA";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@8 { /* CP_MM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <8>;
diff --git a/arch/arm/boot/dts/msm8226/msm8610-ion.dtsi b/arch/arm/boot/dts/msm8226/msm8610-ion.dtsi
index 601f8edd25c..f2a73f4c0e9 100644
--- a/arch/arm/boot/dts/msm8226/msm8610-ion.dtsi
+++ b/arch/arm/boot/dts/msm8226/msm8610-ion.dtsi
@@ -21,11 +21,6 @@
 			qcom,ion-heap-type = "SYSTEM";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@27 { /* QSECOM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <27>;
diff --git a/arch/arm/boot/dts/msm8226/msm8974-ion.dtsi b/arch/arm/boot/dts/msm8226/msm8974-ion.dtsi
index 6ecb7d3e546..8b18644238c 100644
--- a/arch/arm/boot/dts/msm8226/msm8974-ion.dtsi
+++ b/arch/arm/boot/dts/msm8226/msm8974-ion.dtsi
@@ -21,11 +21,6 @@
 			qcom,ion-heap-type = "SYSTEM";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@8 { /* CP_MM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <8>;
diff --git a/arch/arm/boot/dts/msm8226/msmsamarium-ion.dtsi b/arch/arm/boot/dts/msm8226/msmsamarium-ion.dtsi
index 167b8b73ebc..90f49cbf964 100644
--- a/arch/arm/boot/dts/msm8226/msmsamarium-ion.dtsi
+++ b/arch/arm/boot/dts/msm8226/msmsamarium-ion.dtsi
@@ -20,10 +20,5 @@
 			reg = <25>;
 			qcom,ion-heap-type = "SYSTEM";
 		};
-
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
 	};
 };
diff --git a/arch/arm/boot/dts/msm8610-ion.dtsi b/arch/arm/boot/dts/msm8610-ion.dtsi
index 601f8edd25c..f2a73f4c0e9 100644
--- a/arch/arm/boot/dts/msm8610-ion.dtsi
+++ b/arch/arm/boot/dts/msm8610-ion.dtsi
@@ -21,11 +21,6 @@
 			qcom,ion-heap-type = "SYSTEM";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@27 { /* QSECOM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <27>;
diff --git a/arch/arm/boot/dts/msm8610/msm8610-ion.dtsi b/arch/arm/boot/dts/msm8610/msm8610-ion.dtsi
index 891dac46f53..27448be620e 100644
--- a/arch/arm/boot/dts/msm8610/msm8610-ion.dtsi
+++ b/arch/arm/boot/dts/msm8610/msm8610-ion.dtsi
@@ -21,11 +21,6 @@
 			qcom,ion-heap-type = "SYSTEM";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@27 { /* QSECOM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <27>;
diff --git a/arch/arm/boot/dts/msm8974-ion.dtsi b/arch/arm/boot/dts/msm8974-ion.dtsi
index 6ecb7d3e546..8b18644238c 100644
--- a/arch/arm/boot/dts/msm8974-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974-ion.dtsi
@@ -21,11 +21,6 @@
 			qcom,ion-heap-type = "SYSTEM";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@8 { /* CP_MM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <8>;
diff --git a/arch/arm/boot/dts/msm8974/apq8084-ion.dtsi b/arch/arm/boot/dts/msm8974/apq8084-ion.dtsi
index 167b8b73ebc..90f49cbf964 100644
--- a/arch/arm/boot/dts/msm8974/apq8084-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974/apq8084-ion.dtsi
@@ -20,10 +20,5 @@
 			reg = <25>;
 			qcom,ion-heap-type = "SYSTEM";
 		};
-
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
 	};
 };
diff --git a/arch/arm/boot/dts/msm8974/mpq8092-ion.dtsi b/arch/arm/boot/dts/msm8974/mpq8092-ion.dtsi
index 903610d4eb5..c9508b5e7ce 100644
--- a/arch/arm/boot/dts/msm8974/mpq8092-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974/mpq8092-ion.dtsi
@@ -20,12 +20,6 @@
 			reg = <25>;
 			qcom,ion-heap-type = "SYSTEM";
 		};
-
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 	};
 };
 
diff --git a/arch/arm/boot/dts/msm8974/msm8226-ion.dtsi b/arch/arm/boot/dts/msm8974/msm8226-ion.dtsi
index 443334e4d58..03677f32b73 100644
--- a/arch/arm/boot/dts/msm8974/msm8226-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974/msm8226-ion.dtsi
@@ -21,11 +21,6 @@
 			qcom,ion-heap-type = "SYSTEM";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@8 { /* CP_MM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <8>;
diff --git a/arch/arm/boot/dts/msm8974/msm8610-ion.dtsi b/arch/arm/boot/dts/msm8974/msm8610-ion.dtsi
index 601f8edd25c..f2a73f4c0e9 100644
--- a/arch/arm/boot/dts/msm8974/msm8610-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974/msm8610-ion.dtsi
@@ -21,11 +21,6 @@
 			qcom,ion-heap-type = "SYSTEM";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@27 { /* QSECOM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <27>;
diff --git a/arch/arm/boot/dts/msm8974/msmsamarium-ion.dtsi b/arch/arm/boot/dts/msm8974/msmsamarium-ion.dtsi
index 167b8b73ebc..90f49cbf964 100644
--- a/arch/arm/boot/dts/msm8974/msmsamarium-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974/msmsamarium-ion.dtsi
@@ -20,10 +20,5 @@
 			reg = <25>;
 			qcom,ion-heap-type = "SYSTEM";
 		};
-
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
 	};
 };
diff --git a/arch/arm/boot/dts/msm8974pro/apq8084-ion.dtsi b/arch/arm/boot/dts/msm8974pro/apq8084-ion.dtsi
index 167b8b73ebc..90f49cbf964 100644
--- a/arch/arm/boot/dts/msm8974pro/apq8084-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974pro/apq8084-ion.dtsi
@@ -20,10 +20,5 @@
 			reg = <25>;
 			qcom,ion-heap-type = "SYSTEM";
 		};
-
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
 	};
 };
diff --git a/arch/arm/boot/dts/msm8974pro/core/msm8974-ion.dtsi b/arch/arm/boot/dts/msm8974pro/core/msm8974-ion.dtsi
index d9f96ad9298..30d06f2009f 100644
--- a/arch/arm/boot/dts/msm8974pro/core/msm8974-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974pro/core/msm8974-ion.dtsi
@@ -26,11 +26,6 @@
 			qcom,ion-heap-type = "SYSTEM";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@8 { /* CP_MM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <8>;
diff --git a/arch/arm/boot/dts/msm8974pro/mpq8092-ion.dtsi b/arch/arm/boot/dts/msm8974pro/mpq8092-ion.dtsi
index 903610d4eb5..c9508b5e7ce 100644
--- a/arch/arm/boot/dts/msm8974pro/mpq8092-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974pro/mpq8092-ion.dtsi
@@ -20,12 +20,6 @@
 			reg = <25>;
 			qcom,ion-heap-type = "SYSTEM";
 		};
-
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 	};
 };
 
diff --git a/arch/arm/boot/dts/msm8974pro/msm8226-ion.dtsi b/arch/arm/boot/dts/msm8974pro/msm8226-ion.dtsi
index 06e2779e824..4085cef4111 100644
--- a/arch/arm/boot/dts/msm8974pro/msm8226-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974pro/msm8226-ion.dtsi
@@ -21,11 +21,6 @@
 			qcom,ion-heap-type = "SYSTEM";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@8 { /* CP_MM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <8>;
diff --git a/arch/arm/boot/dts/msm8974pro/msm8610-ion.dtsi b/arch/arm/boot/dts/msm8974pro/msm8610-ion.dtsi
index 601f8edd25c..f2a73f4c0e9 100644
--- a/arch/arm/boot/dts/msm8974pro/msm8610-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974pro/msm8610-ion.dtsi
@@ -21,11 +21,6 @@
 			qcom,ion-heap-type = "SYSTEM";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@27 { /* QSECOM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <27>;
diff --git a/arch/arm/boot/dts/msm8974pro/msm8974-ion.dtsi b/arch/arm/boot/dts/msm8974pro/msm8974-ion.dtsi
index 5829f0582f9..40e4a3ff63d 100644
--- a/arch/arm/boot/dts/msm8974pro/msm8974-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974pro/msm8974-ion.dtsi
@@ -21,11 +21,6 @@
 			qcom,ion-heap-type = "SYSTEM";
 		};
 
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
-
 		qcom,ion-heap@8 { /* CP_MM HEAP */
 			compatible = "qcom,msm-ion-reserve";
 			reg = <8>;
diff --git a/arch/arm/boot/dts/msm8974pro/msmsamarium-ion.dtsi b/arch/arm/boot/dts/msm8974pro/msmsamarium-ion.dtsi
index 167b8b73ebc..90f49cbf964 100644
--- a/arch/arm/boot/dts/msm8974pro/msmsamarium-ion.dtsi
+++ b/arch/arm/boot/dts/msm8974pro/msmsamarium-ion.dtsi
@@ -20,10 +20,5 @@
 			reg = <25>;
 			qcom,ion-heap-type = "SYSTEM";
 		};
-
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
 	};
 };
diff --git a/arch/arm/boot/dts/msmsamarium-ion.dtsi b/arch/arm/boot/dts/msmsamarium-ion.dtsi
index 167b8b73ebc..90f49cbf964 100644
--- a/arch/arm/boot/dts/msmsamarium-ion.dtsi
+++ b/arch/arm/boot/dts/msmsamarium-ion.dtsi
@@ -20,10 +20,5 @@
 			reg = <25>;
 			qcom,ion-heap-type = "SYSTEM";
 		};
-
-		qcom,ion-heap@21 {
-			reg = <21>;
-			qcom,ion-heap-type = "SYSTEM_CONTIG";
-		};
 	};
 };
diff --git a/drivers/gpu/ion/ion_heap.c b/drivers/gpu/ion/ion_heap.c
index ad9a691da87..1a8f3c49658 100644
--- a/drivers/gpu/ion/ion_heap.c
+++ b/drivers/gpu/ion/ion_heap.c
@@ -2,7 +2,7 @@
  * drivers/gpu/ion/ion_heap.c
  *
  * Copyright (C) 2011 Google, Inc.
- * Copyright (c) 2011-2014, The Linux Foundation. All rights reserved.
+ * Copyright (c) 2011-2014,2016 The Linux Foundation. All rights reserved.
  *
  * This software is licensed under the terms of the GNU General Public
  * License version 2, as published by the Free Software Foundation, and
