From 85d40ce6f481dfb1c17c99c7892e90d02f48eb98 Mon Sep 17 00:00:00 2001
From: Luca Weiss <luca.weiss@fairphone.com>
Date: Tue, 28 Sep 2021 10:22:31 +0200
Subject: [PATCH] msm: audio: qdsp6v2: rate limit an error message

Our kernel doesn't like log spam.

Issue: SEC-2435
Test: run sts-engbuild-no-spl-lock -m StsHostTestCases -t android.security.sts.Poc16_12#testPocCVE_2016_8391
Change-Id: Ic66b306a209cfba710bcf8a6d600e9234cc77d31
---
 arch/arm/mach-msm/qdsp6v2/audio_aac.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/arch/arm/mach-msm/qdsp6v2/audio_aac.c b/arch/arm/mach-msm/qdsp6v2/audio_aac.c
index d95c3565672..bdbc8f0e8c3 100644
--- a/arch/arm/mach-msm/qdsp6v2/audio_aac.c
+++ b/arch/arm/mach-msm/qdsp6v2/audio_aac.c
@@ -16,6 +16,7 @@
  */
 
 #include <linux/msm_audio_aac.h>
+#include <linux/ratelimit.h>
 #include "audio_utils_aio.h"
 
 #define AUDIO_AAC_DUAL_MONO_INVALID -1
@@ -185,7 +186,7 @@ static long audio_ioctl(struct file *file, unsigned int cmd, unsigned long arg)
 		pr_debug("%s[%p]: Calling utils ioctl\n", __func__, audio);
 		rc = audio->codec_ioctl(file, cmd, arg);
 		if (rc)
-			pr_err("%s[%p]:Failed in utils_ioctl: %d\n",
+			pr_err_ratelimited("%s[%p]:Failed in utils_ioctl: %d\n",
 				__func__, audio, rc);
 	}
 	return rc;
