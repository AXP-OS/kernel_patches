From efe30ba2843094790dfcb91bad485b5a3ea1122b Mon Sep 17 00:00:00 2001
From: Saranya Chidura <schidura@codeaurora.org>
Date: Wed, 26 Jul 2017 17:37:17 +0530
Subject: [PATCH] coresight: tmc: Fix the unbalanced lock in tmc_read()

'commit 734aabed17090: ("coresight: tmc: Fix use after free issue
with tmc read")' adds lock in tmc_read() to fix race condition seen in
reading tmc buffer and enabling the device.But commit has unbalanced
lock. This patch fixes the lock.

Bug: 64453422
Change-Id: Iaf3ecd83ef5af346725885ea2c84c4185f1a1c50
Signed-off-by: Saranya Chidura <schidura@codeaurora.org>
CVE-2017-11033
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>
---
 drivers/coresight/coresight-tmc.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/coresight/coresight-tmc.c b/drivers/coresight/coresight-tmc.c
index affa8958f77..e406e44232e 100644
--- a/drivers/coresight/coresight-tmc.c
+++ b/drivers/coresight/coresight-tmc.c
@@ -987,7 +987,7 @@ static ssize_t tmc_read(struct file *file, char __user *data, size_t len,
 	dev_dbg(drvdata->dev, "%s: %d bytes copied, %d bytes left\n",
 		__func__, len, (int) (drvdata->size - *ppos));
 
-	mutex_lock(&drvdata->usb_lock);
+	mutex_unlock(&drvdata->usb_lock);
 	return len;
 }
 
