From aeb7bcf516dfa00295329ec66bd0b62d746f4bbe Mon Sep 17 00:00:00 2001
From: Sridhar Selvaraj <sselvara@codeaurora.org>
Date: Thu, 29 Jun 2017 19:25:39 +0530
Subject: qcacld-2.0: Add check for set_ft_ies buffer length

qcacld-3.0 to qcacld-2.0 propagation.

Add check for buffer length in function sme_SetFTIEs

Change-Id: I7adc56e23316c0ceb193a5bdf8c4c0b5f4fbd20a
CRs-Fixed: 2070583
---
 CORE/HDD/src/wlan_hdd_wext.c        | 3 +++
 CORE/SME/src/sme_common/sme_FTApi.c | 9 ++++++---
 2 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/CORE/HDD/src/wlan_hdd_wext.c b/CORE/HDD/src/wlan_hdd_wext.c
index a225c6f..016587c 100644
--- a/CORE/HDD/src/wlan_hdd_wext.c
+++ b/CORE/HDD/src/wlan_hdd_wext.c
@@ -12585,6 +12585,9 @@ static const struct iw_priv_args we_private_args[] = {
     {   WE_DUMP_DP_TRACE_LEVEL,
         IW_PRIV_TYPE_INT | IW_PRIV_SIZE_FIXED | 2,
         0, "dump_dp_trace"},
+    {   WLAN_PRIV_SET_FTIES,
+        IW_PRIV_TYPE_CHAR | MAX_FTIE_SIZE,
+        0, "set_ft_ies"},
 };
 
 
diff --git a/CORE/SME/src/sme_common/sme_FTApi.c b/CORE/SME/src/sme_common/sme_FTApi.c
index 26a7ef8..86febe9 100644
--- a/CORE/SME/src/sme_common/sme_FTApi.c
+++ b/CORE/SME/src/sme_common/sme_FTApi.c
@@ -163,6 +163,9 @@ void sme_SetFTIEs(tHalHandle hHal, tANI_U32 sessionId, const tANI_U8 *ft_ies,
    {
       case eFT_START_READY:
       case eFT_AUTH_REQ_READY:
+#if defined WLAN_FEATURE_VOWIFI_11R_DEBUG
+         smsLog(pMac, LOG1, "ft_ies_length: %d", ft_ies_length);
+#endif
          if ((pSession->ftSmeContext.auth_ft_ies) &&
                (pSession->ftSmeContext.auth_ft_ies_length))
          {
@@ -171,14 +174,17 @@ void sme_SetFTIEs(tHalHandle hHal, tANI_U32 sessionId, const tANI_U8 *ft_ies,
             pSession->ftSmeContext.auth_ft_ies_length = 0;
             pSession->ftSmeContext.auth_ft_ies = NULL;
          }
+         ft_ies_length = MIN(ft_ies_length, MAX_FTIE_SIZE);
 
          // Save the FT IEs
          pSession->ftSmeContext.auth_ft_ies =
             vos_mem_malloc(ft_ies_length);
          if ( NULL == pSession->ftSmeContext.auth_ft_ies )
          {
+#if defined WLAN_FEATURE_VOWIFI_11R_DEBUG
             smsLog( pMac, LOGE, FL("Memory allocation failed for "
                      "auth_ft_ies"));
+#endif
             sme_ReleaseGlobalLock( &pMac->sme );
             return;
          }
@@ -187,9 +193,6 @@ void sme_SetFTIEs(tHalHandle hHal, tANI_U32 sessionId, const tANI_U8 *ft_ies,
                ft_ies,ft_ies_length);
          pSession->ftSmeContext.FTState = eFT_AUTH_REQ_READY;
 
-#if defined WLAN_FEATURE_VOWIFI_11R_DEBUG
-         smsLog( pMac, LOG1, "ft_ies_length=%d", ft_ies_length);
-#endif
          break;
 
       case eFT_AUTH_COMPLETE:
-- 
cgit v1.1

