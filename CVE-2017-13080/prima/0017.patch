From 3aa9e099893ab470fdc37fa95fb844e482f64534 Mon Sep 17 00:00:00 2001
From: Sravan Kumar Kairam <sgoud@codeaurora.org>
Date: Fri, 10 Nov 2017 16:23:10 +0530
Subject: [PATCH] wlan: Retrieve sta id for only PTK key

Currently at add key mac address is NULL for GTK key. So while
retrieving sta id system crashes as address is NULL. In this
change check if pairwise key and then only retrieve sta id from
mac.

Change-Id: I2f2f6e0e10cdc6eabd78ff2dc5108969403d9a27
CRs-Fixed: 2141572
---
 CORE/HDD/inc/wlan_hdd_main.h     |  3 +++
 CORE/HDD/src/wlan_hdd_cfg80211.c | 14 +++++++++-----
 2 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/CORE/HDD/inc/wlan_hdd_main.h b/CORE/HDD/inc/wlan_hdd_main.h
index 7545e9c338..b13a395b71 100644
--- a/CORE/HDD/inc/wlan_hdd_main.h
+++ b/CORE/HDD/inc/wlan_hdd_main.h
@@ -234,6 +234,9 @@ typedef v_U8_t tWlanHddMacAddr[HDD_MAC_ADDR_LEN];
 #define MIN(a, b) (a > b ? b : a)
 
 #endif
+
+#define HDD_MAX_STA_COUNT (HAL_NUM_STA)
+
 /*
  * Generic asynchronous request/response support
  *
diff --git a/CORE/HDD/src/wlan_hdd_cfg80211.c b/CORE/HDD/src/wlan_hdd_cfg80211.c
index 26df067714..e169948ca1 100644
--- a/CORE/HDD/src/wlan_hdd_cfg80211.c
+++ b/CORE/HDD/src/wlan_hdd_cfg80211.c
@@ -9006,9 +9006,11 @@ static int __wlan_hdd_cfg80211_add_key( struct wiphy *wiphy,
     VOS_STATUS vos_status;
     eHalStatus halStatus;
     hdd_context_t *pHddCtx;
-    uint8_t staid, i;
+    uint8_t i;
     v_MACADDR_t *peerMacAddr;
     u64 rsc_counter = 0;
+    uint8_t staid = HDD_MAX_STA_COUNT;
+    bool pairwise_set_key = false;
 
     ENTER();
 
@@ -9165,6 +9167,7 @@ static int __wlan_hdd_cfg80211_add_key( struct wiphy *wiphy,
                 __func__, __LINE__);
         setKey.keyDirection = eSIR_TX_RX;
         vos_mem_copy(setKey.peerMac, mac_addr,WNI_CFG_BSSID_LEN);
+        pairwise_set_key = true;
     }
     if ((WLAN_HDD_IBSS == pAdapter->device_mode) && !pairwise)
     {
@@ -9195,7 +9198,8 @@ static int __wlan_hdd_cfg80211_add_key( struct wiphy *wiphy,
             hdd_station_ctx_t *pHddStaCtx = WLAN_HDD_GET_STATION_CTX_PTR(pAdapter);
             vos_status = wlan_hdd_check_ula_done(pAdapter);
 
-            staid = hdd_sta_id_find_from_mac_addr(pAdapter, peerMacAddr);
+            if (peerMacAddr && (pairwise_set_key == true))
+                staid = hdd_sta_id_find_from_mac_addr(pAdapter, peerMacAddr);
 
             if ( vos_status != VOS_STATUS_SUCCESS )
             {
@@ -9258,7 +9262,8 @@ static int __wlan_hdd_cfg80211_add_key( struct wiphy *wiphy,
             }
         }
 
-        staid = pHddStaCtx->conn_info.staId[0];
+        if (pairwise_set_key == true)
+           staid = pHddStaCtx->conn_info.staId[0];
 
         pWextState->roamProfile.Keys.KeyLength[key_index] = (u8)params->key_len;
 
@@ -9367,11 +9372,10 @@ static int __wlan_hdd_cfg80211_add_key( struct wiphy *wiphy,
         }
     }
 
-    if (pairwise) {
+    if (pairwise_set_key == true) {
        for (i = 0; i < params->seq_len; i++) {
           rsc_counter |= (params->seq[i] << i*8);
        }
-
        WLANTL_SetKeySeqCounter(pVosContext, rsc_counter, staid);
     }
 
-- 
GitLab

