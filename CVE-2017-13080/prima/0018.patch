From 1a640c85f52c3c4f73bfc5f4dedde24dec45a8fe Mon Sep 17 00:00:00 2001
From: Sravan Kumar Kairam <sgoud@codeaurora.org>
Date: Fri, 10 Nov 2017 16:23:10 +0530
Subject: wlan: Retrieve sta id for only PTK key

Currently at add key mac address is NULL for GTK key. So while
retrieving sta id system crashes as address is NULL. In this
change check if pairwise key and then only retrieve sta id from
mac.

Change-Id: I2f2f6e0e10cdc6eabd78ff2dc5108969403d9a27
CRs-Fixed: 2141572
---
 CORE/HDD/src/wlan_hdd_cfg80211.c | 14 +++++++++-----
 1 file changed, 9 insertions(+), 5 deletions(-)

diff --git a/CORE/HDD/src/wlan_hdd_cfg80211.c b/CORE/HDD/src/wlan_hdd_cfg80211.c
index eb20350..3302fdf 100644
--- a/CORE/HDD/src/wlan_hdd_cfg80211.c
+++ b/CORE/HDD/src/wlan_hdd_cfg80211.c
@@ -10681,9 +10681,11 @@ static int __wlan_hdd_cfg80211_add_key( struct wiphy *wiphy,
     VOS_STATUS vos_status;
     eHalStatus halStatus;
     hdd_context_t *pHddCtx;
-    uint8_t staid, i;
+    uint8_t i;
     v_MACADDR_t *peerMacAddr;
     u64 rsc_counter = 0;
+    uint8_t staid = HDD_MAX_STA_COUNT;
+    bool pairwise_set_key = false;
 
     ENTER();
 
@@ -10840,6 +10842,7 @@ static int __wlan_hdd_cfg80211_add_key( struct wiphy *wiphy,
                 __func__, __LINE__);
         setKey.keyDirection = eSIR_TX_RX;
         vos_mem_copy(setKey.peerMac, mac_addr,WNI_CFG_BSSID_LEN);
+        pairwise_set_key = true;
     }
     if ((WLAN_HDD_IBSS == pAdapter->device_mode) && !pairwise)
     {
@@ -10870,7 +10873,8 @@ static int __wlan_hdd_cfg80211_add_key( struct wiphy *wiphy,
             hdd_station_ctx_t *pHddStaCtx = WLAN_HDD_GET_STATION_CTX_PTR(pAdapter);
             vos_status = wlan_hdd_check_ula_done(pAdapter);
 
-            staid = hdd_sta_id_find_from_mac_addr(pAdapter, peerMacAddr);
+            if (peerMacAddr && (pairwise_set_key == true))
+                staid = hdd_sta_id_find_from_mac_addr(pAdapter, peerMacAddr);
 
             if ( vos_status != VOS_STATUS_SUCCESS )
             {
@@ -10933,7 +10937,8 @@ static int __wlan_hdd_cfg80211_add_key( struct wiphy *wiphy,
             }
         }
 
-        staid = pHddStaCtx->conn_info.staId[0];
+        if (pairwise_set_key == true)
+           staid = pHddStaCtx->conn_info.staId[0];
 
         pWextState->roamProfile.Keys.KeyLength[key_index] = (u8)params->key_len;
 
@@ -11042,11 +11047,10 @@ static int __wlan_hdd_cfg80211_add_key( struct wiphy *wiphy,
         }
     }
 
-    if (pairwise) {
+    if (pairwise_set_key == true) {
        for (i = 0; i < params->seq_len; i++) {
           rsc_counter |= (params->seq[i] << i*8);
        }
-
        WLANTL_SetKeySeqCounter(pVosContext, rsc_counter, staid);
     }
 
-- 
cgit v1.1

