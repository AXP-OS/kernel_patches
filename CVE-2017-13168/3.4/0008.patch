From ed99cbadf820b4ab63e0ba61c9c90ec9a3a0d192 Mon Sep 17 00:00:00 2001
From: Roberto Pereira <rpere@google.com>
Date: Tue, 10 Oct 2017 17:14:48 -0700
Subject: [PATCH] ANDROID: scsi: Add segment checking in sg_read

Bug: 65023233
Signed-off-by: Roberto Pereira <rpere@google.com>
Change-Id: Ib45f402cf304f9b8bf18884738f92b9c3db55573
CVE-2017-13168
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>
---
 drivers/scsi/sg.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/scsi/sg.c b/drivers/scsi/sg.c
index 88c8140a6a5..a1612c3a7bc 100644
--- a/drivers/scsi/sg.c
+++ b/drivers/scsi/sg.c
@@ -358,6 +358,9 @@ sg_read(struct file *filp, char __user *buf, size_t count, loff_t * ppos)
 	struct sg_header *old_hdr = NULL;
 	int retval = 0;
 
+	if (unlikely(segment_eq(get_fs(), KERNEL_DS)))
+		return -EINVAL;
+
 	if ((!(sfp = (Sg_fd *) filp->private_data)) || (!(sdp = sfp->parentdp)))
 		return -ENXIO;
 	SCSI_LOG_TIMEOUT(3, printk("sg_read: %s, count=%d\n",
