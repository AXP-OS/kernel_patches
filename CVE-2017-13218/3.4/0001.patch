From f7f0bbdf314a677fd2159939034f32b239e4a38a Mon Sep 17 00:00:00 2001
From: Greg Hackmann <ghackmann@google.com>
Date: Tue, 19 Sep 2017 10:55:17 -0700
Subject: [PATCH] clocksource: arch_timer: make virtual counter access
 configurable

Bug: 68266545
Change-Id: Ibdb1fd768b748002b90bfc165612c12c8311f8a2
CVE-2017-13218
[haggertk: backport to msm8974/3.4]
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>
(cherry picked from commit f66862b820caa6f8d6a24752848c60f28cb96890)
---
 arch/arm/Kconfig                  | 8 ++++++++
 arch/arm/include/asm/arch_timer.h | 5 ++++-
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/arch/arm/Kconfig b/arch/arm/Kconfig
index 4f0cc6bf8b9..7a667f07ca3 100644
--- a/arch/arm/Kconfig
+++ b/arch/arm/Kconfig
@@ -1701,6 +1701,14 @@ config ARM_ARCH_TIMER
 	help
 	  This option enables support for the ARM architected timer
 
+config ARM_ARCH_TIMER_VCT_ACCESS
+	bool "Support for ARM architected timer virtual counter access in userspace"
+	default n
+	depends on ARM_ARCH_TIMER
+	help
+	  This option enables support for reading the ARM architected timer's
+	  virtual counter in userspace.
+
 config HAVE_ARM_TWD
 	bool
 	depends on SMP
diff --git a/arch/arm/include/asm/arch_timer.h b/arch/arm/include/asm/arch_timer.h
index c6cf97849c8..657c9ba5ad9 100644
--- a/arch/arm/include/asm/arch_timer.h
+++ b/arch/arm/include/asm/arch_timer.h
@@ -46,7 +46,10 @@ static inline void arch_counter_set_user_access(void)
 			| ARCH_TIMER_USR_PCT_ACCESS_EN);
 
 	/* Enable user access to the virtual counter */
-	cntkctl |= ARCH_TIMER_USR_VCT_ACCESS_EN;
+	if (IS_ENABLED(CONFIG_ARM_ARCH_TIMER_VCT_ACCESS))
+		cntkctl |= ARCH_TIMER_USR_VCT_ACCESS_EN;
+	else
+		cntkctl &= ~ARCH_TIMER_USR_VCT_ACCESS_EN;
 
 	arch_timer_set_cntkctl(cntkctl);
 }
