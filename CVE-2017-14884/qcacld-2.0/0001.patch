From 0ce15ef4075719a82858b7324690be7011cab832 Mon Sep 17 00:00:00 2001
From: Paul Zhang <paulz@codeaurora.org>
Date: Thu, 21 Sep 2017 13:37:24 +0800
Subject: qcacld-2.0: Prevent buffer overflow

In function WLANQCMBR_McProcessMsg, variable data_len
is from message, which should not be trusted. Buffer
overflow will happen if using it directory to copy data
to utf_buf.

Change-Id: I21479f510b95e6ced214f80d942db919837e8324
CRs-Fixed: 2113052
---
 CORE/HDD/src/wlan_hdd_ftm.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/CORE/HDD/src/wlan_hdd_ftm.c b/CORE/HDD/src/wlan_hdd_ftm.c
index 8ac2ad5..acf8c77 100644
--- a/CORE/HDD/src/wlan_hdd_ftm.c
+++ b/CORE/HDD/src/wlan_hdd_ftm.c
@@ -1079,8 +1079,10 @@ static void WLANQCMBR_McProcessMsg(v_VOID_t *message)
     u_int32_t data_len;
 
     data_len = *((u_int32_t *)message) + sizeof(u_int32_t);
-    qcmbr_buf = kzalloc(sizeof(qcmbr_queue_t), GFP_KERNEL);
+    if (data_len > MAX_UTF_LENGTH + 4)
+        return;
 
+    qcmbr_buf = kzalloc(sizeof(qcmbr_queue_t), GFP_KERNEL);
     if (qcmbr_buf != NULL) {
         memcpy(qcmbr_buf->utf_buf, message, data_len);
         spin_lock_bh(&qcmbr_queue_lock);
-- 
cgit v1.1

