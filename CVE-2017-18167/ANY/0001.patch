From 7eabecedefe1b9e95cfd1ab8d47101af2d906e3d Mon Sep 17 00:00:00 2001
From: Gopikrishnaiah Anandan <agopik@codeaurora.org>
Date: Tue, 16 May 2017 19:02:18 -0700
Subject: msm: mdss: Clean-up payload for unsupported versions

When 32 bit process calls the post processing ioctls compat layer
functions will be called. If post processing version is not supported
payload needs to be freed. Change adds support for clean-up.

Change-Id: Ib3c4d60b858ddd952a3906946458aa2bf2c69076
Signed-off-by: Gopikrishnaiah Anandan <agopik@codeaurora.org>
---
 drivers/video/fbdev/msm/mdss_compat_utils.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/video/fbdev/msm/mdss_compat_utils.c b/drivers/video/fbdev/msm/mdss_compat_utils.c
index 2b9c714..2f5aad8e 100644
--- a/drivers/video/fbdev/msm/mdss_compat_utils.c
+++ b/drivers/video/fbdev/msm/mdss_compat_utils.c
@@ -3493,6 +3493,7 @@ static int __copy_layer_pp_info_igc_params(
 			compat_ptr(pp_info32->igc_cfg.c0_c1_data);
 		pp_info->igc_cfg.c2_data =
 			compat_ptr(pp_info32->igc_cfg.c2_data);
+		kfree(cfg_payload);
 		cfg_payload = NULL;
 		break;
 	}
@@ -3565,6 +3566,7 @@ static int __copy_layer_pp_info_hist_lut_params(
 		pp_info->hist_lut_cfg.len = pp_info32->hist_lut_cfg.len;
 		pp_info->hist_lut_cfg.data =
 				compat_ptr(pp_info32->hist_lut_cfg.data);
+		kfree(cfg_payload);
 		cfg_payload = NULL;
 		break;
 	}
@@ -3654,6 +3656,7 @@ static int __copy_layer_pp_info_pa_v2_params(
 		break;
 	default:
 		pr_debug("version invalid\n");
+		kfree(cfg_payload);
 		cfg_payload = NULL;
 		break;
 	}
@@ -3737,6 +3740,7 @@ static int __copy_layer_pp_info_pcc_params(
 		break;
 	default:
 		pr_debug("version invalid, fallback to legacy\n");
+		kfree(cfg_payload);
 		cfg_payload = NULL;
 		break;
 	}
-- 
cgit v1.1

