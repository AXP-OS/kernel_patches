From c5c90f875b5ec124e750a890abf06d22e2110305 Mon Sep 17 00:00:00 2001
From: "Kevin F. Haggerty" <haggertk@lineageos.org>
Date: Fri, 23 Feb 2018 16:03:24 -0700
Subject: [PATCH] VFS: Properly free dentry name snapshots in vfs_rename2

An error in commit 0a420e78c31b ("BACKPORT: dentry name snapshots")
errantly replaced the fsnotify_oldname_free() with a
take_dentry_name_snapshot() instead of the intended
release_dentry_name_snapshot() as demonstrated in the upstream
commit. This results in taking another snapshot and leaking of the
memory allocated for the snapshot name.

Change-Id: I13356a0cc12fbaf63330d6781ad65ed735e6bc0d
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>
Fixes: 0a420e78c31b ("BACKPORT: dentry name snapshots")
---
 fs/namei.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/fs/namei.c b/fs/namei.c
index f271a8bda3c..dc9718db08b 100644
--- a/fs/namei.c
+++ b/fs/namei.c
@@ -3393,7 +3393,7 @@ int vfs_rename2(struct vfsmount *mnt,
 	if (!error)
 		fsnotify_move(old_dir, new_dir, old_name.name, is_dir,
 			      new_dentry->d_inode, old_dentry);
-	take_dentry_name_snapshot(&old_name, old_dentry);
+	release_dentry_name_snapshot(&old_name);
 
 	return error;
 }
