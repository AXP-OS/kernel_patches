From 9f891b7f692c77b3da24fc4bef5afd68029ba9a9 Mon Sep 17 00:00:00 2001
From: Zhen Kong <zkong@codeaurora.org>
Date: Mon, 27 Feb 2017 13:41:07 -0800
Subject: [PATCH] qseecom: add mutex around qseecom_set_client_mem_param

Add mutex around qseecom_set_client_mem_param to prevent an
ioctl thread modifying and corrupting data which is being
processed by another ioctl in the other thread

CAF-Change-Id: I0cfb8afab4001c2913be693dfe44c761b9568893
Signed-off-by: Zhen Kong <zkong@codeaurora.org>
CVE-2017-8242
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>

Change-Id: I9974bf8f3cf42f6c3c17d92d0d5c51b60e34c6d9
---
 drivers/misc/qseecom.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/misc/qseecom.c b/drivers/misc/qseecom.c
index 6fdaae726f7..d3c72df2e56 100644
--- a/drivers/misc/qseecom.c
+++ b/drivers/misc/qseecom.c
@@ -4055,7 +4055,11 @@ static long qseecom_ioctl(struct file *file, unsigned cmd,
 			break;
 		}
 		pr_debug("SET_MEM_PARAM: qseecom addr = 0x%x\n", (u32)data);
+		mutex_lock(&app_access_lock);
+		atomic_inc(&data->ioctl_count);
 		ret = qseecom_set_client_mem_param(data, argp);
+		atomic_dec(&data->ioctl_count);
+		mutex_unlock(&app_access_lock);
 		if (ret)
 			pr_err("failed Qqseecom_set_mem_param request: %d\n",
 								ret);
