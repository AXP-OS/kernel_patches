From 9ee05b2b784ef23cd5773cfcc4561329a4b2834e Mon Sep 17 00:00:00 2001
From: Trishansh Bhardwaj <tbhardwa@codeaurora.org>
Date: Fri, 7 Apr 2017 11:16:29 +0530
Subject: [PATCH] msm: camera: Allow driver file to be opend only once.

Use proper synchronization to ensure driver file is opened
only once.

CRs-Fixed: 2023513
Change-Id: I71e55e2d487fe561d3f596590b3e8102c5e921b5
Signed-off-by: Trishansh Bhardwaj <tbhardwa@codeaurora.org>
CVE-2017-8247
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>
---
 drivers/media/platform/msm/camera_ll/msm.c | 3 +--
 drivers/media/platform/msm/camera_v2/msm.c | 3 +--
 2 files changed, 2 insertions(+), 4 deletions(-)

diff --git a/drivers/media/platform/msm/camera_ll/msm.c b/drivers/media/platform/msm/camera_ll/msm.c
index bf04a8b5789..ef1a72a46ae 100644
--- a/drivers/media/platform/msm/camera_ll/msm.c
+++ b/drivers/media/platform/msm/camera_ll/msm.c
@@ -847,11 +847,10 @@ static int msm_open(struct file *filep)
 	BUG_ON(!pvdev);
 
 	/* !!! only ONE open is allowed !!! */
-	if (atomic_read(&pvdev->opened)) {
+	if (atomic_cmpxchg(&pvdev->opened, 0, 1)) {
 		pr_err("__dbg: Already device node is in opened state \n");
 		return -EBUSY;
 	}
-	atomic_set(&pvdev->opened, 1);
 
 	spin_lock_irqsave(&msm_pid_lock, flags);
 	msm_pid = get_pid(task_pid(current));
diff --git a/drivers/media/platform/msm/camera_v2/msm.c b/drivers/media/platform/msm/camera_v2/msm.c
index 800d7e2bbd6..0ac553c66df 100644
--- a/drivers/media/platform/msm/camera_v2/msm.c
+++ b/drivers/media/platform/msm/camera_v2/msm.c
@@ -866,11 +866,10 @@ static int msm_open(struct file *filep)
 	BUG_ON(!pvdev);
 
 	/* !!! only ONE open is allowed !!! */
-	if (atomic_read(&pvdev->opened)) {
+	if (atomic_cmpxchg(&pvdev->opened, 0, 1)) {
 		pr_err("__dbg: Already device node is in opened state \n");
 		return -EBUSY;
 	}
-	atomic_set(&pvdev->opened, 1);
 
 	spin_lock_irqsave(&msm_pid_lock, flags);
 	msm_pid = get_pid(task_pid(current));
