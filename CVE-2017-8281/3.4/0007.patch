From f10987db9ec010672201c2892c80c0a585afe159 Mon Sep 17 00:00:00 2001
From: Mohit Aggarwal <maggarwa@codeaurora.org>
Date: Sat, 22 Apr 2017 10:49:18 +0530
Subject: [PATCH] diag: dci: Add protection while querying event status

Currently, protection is missing when querying event
status due to which already removed dci client entry
might be accessed. This patch takes care of issue by
taking proper locking.

CRs-Fixed: 2015892
Change-Id: I4195c4c6198d85e96559f1728d74419527a76bc5
Signed-off-by: Mohit Aggarwal <maggarwa@codeaurora.org>
[haggertk]: Backport to 3.4
CVE-2017-8281
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>
---
 drivers/char/diag/diagchar_core.c | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/drivers/char/diag/diagchar_core.c b/drivers/char/diag/diagchar_core.c
index 7e1f1021acb..3afd5e80f67 100644
--- a/drivers/char/diag/diagchar_core.c
+++ b/drivers/char/diag/diagchar_core.c
@@ -1081,14 +1081,20 @@ long diagchar_ioctl(struct file *filp,
 		result = DIAG_DCI_NO_ERROR;
 		break;
 	case DIAG_IOCTL_DCI_EVENT_STATUS:
+		mutex_lock(&driver->dci_mutex);
 		if (copy_from_user(&le_stats, (void *)ioarg,
-					sizeof(struct diag_log_event_stats)))
+					sizeof(struct diag_log_event_stats))) {
+			mutex_unlock(&driver->dci_mutex);
 			return -EFAULT;
+		}
 		le_stats.is_set = diag_dci_query_event_mask(le_stats.code);
 		if (copy_to_user((void *)ioarg, &le_stats,
-				sizeof(struct diag_log_event_stats)))
+				sizeof(struct diag_log_event_stats))) {
+			mutex_unlock(&driver->dci_mutex);
 			return -EFAULT;
+		}
 		result = DIAG_DCI_NO_ERROR;
+		mutex_unlock(&driver->dci_mutex);
 		break;
 	case DIAG_IOCTL_DCI_CLEAR_LOGS:
 		if (copy_from_user((void *)&client_id, (void *)ioarg,
