From b0305a80f862d491f9c3ec5c7c229453e63c6a27 Mon Sep 17 00:00:00 2001
From: "Kevin F. Haggerty" <haggertk@lineageos.org>
Date: Thu, 14 Sep 2017 07:23:37 -0600
Subject: [PATCH] usb: gadget: qc_rndis: Clean up code to allow patches to
 apply cleanly

Change-Id: Ib77e131591d0518199c3cc01e1770858200354e7
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>
---
 drivers/usb/gadget/f_qc_rndis.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/drivers/usb/gadget/f_qc_rndis.c b/drivers/usb/gadget/f_qc_rndis.c
index c0f95e8830c..3579d33d6b4 100644
--- a/drivers/usb/gadget/f_qc_rndis.c
+++ b/drivers/usb/gadget/f_qc_rndis.c
@@ -1107,10 +1107,13 @@ rndis_qc_bind_config_vendor(struct usb_configuration *c, u8 ethaddr[ETH_ALEN],
 
 	status = usb_add_function(c, &rndis->port.func);
 	if (status) {
-		kfree(rndis);
-fail:
-		rndis_exit();
+		goto fail;
 	}
+
+fail:
+  kfree(rndis);
+  _rndis_qc = NULL;
+	rndis_exit();
 	return status;
 }
 
