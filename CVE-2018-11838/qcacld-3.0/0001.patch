From d98aa07b53021e269afa337e89408418103367be Mon Sep 17 00:00:00 2001
From: gaurank kathpalia <gkathpal@codeaurora.org>
Date: Mon, 11 Jun 2018 21:24:29 +0530
Subject: qcacld-3.0: Fix memory double free condition in wma_roam_update_vdev

The driver allocates memory to del_sta_params in API
wma_roam_update_vdev. In the call of wma_delete_sta API
the driver does mem-free for del_sta_params

But in the main API wma_roam_update_vdev, after the function call
of wma_delete_sta, the driver does mem-free again, which could
mem free of memory block allocated to some other block.
Fix is to remove the mem-free of del_sta_params
in API wma_roam_update_vdev

Change-Id: I79c69f6e6f10650cd57fd85dc4d79e8677976247
CRs-Fixed: 2214574
---
 core/wma/src/wma_dev_if.c       | 9 ++++++++-
 core/wma/src/wma_nan_datapath.c | 4 ++++
 core/wma/src/wma_scan_roam.c    | 1 -
 3 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/core/wma/src/wma_dev_if.c b/core/wma/src/wma_dev_if.c
index 4a5fecf..136cd5b 100644
--- a/core/wma/src/wma_dev_if.c
+++ b/core/wma/src/wma_dev_if.c
@@ -4882,8 +4882,12 @@ void wma_delete_sta(tp_wma_handle wma, tpDeleteStaParams del_sta)
 	switch (oper_mode) {
 	case BSS_OPERATIONAL_MODE_STA:
 		wma_delete_sta_req_sta_mode(wma, del_sta);
-		if (wma_is_roam_synch_in_progress(wma, smesession_id))
+		if (wma_is_roam_synch_in_progress(wma, smesession_id)) {
+			WMA_LOGD(FL("LFR3: Del STA on vdev_id %d"),
+				 del_sta->smesessionId);
+			qdf_mem_free(del_sta);
 			return;
+		}
 		if (!rsp_requested) {
 			WMA_LOGD(FL("vdev_id %d status %d"),
 				 del_sta->smesessionId, del_sta->status);
@@ -4912,6 +4916,9 @@ void wma_delete_sta(tp_wma_handle wma, tpDeleteStaParams del_sta)
 	case BSS_OPERATIONAL_MODE_NDI:
 		wma_delete_sta_req_ndi_mode(wma, del_sta);
 		break;
+	default:
+		WMA_LOGE(FL("Incorrect oper mode %d"), oper_mode);
+		qdf_mem_free(del_sta);
 	}
 
 #ifdef QCA_IBSS_SUPPORT
diff --git a/core/wma/src/wma_nan_datapath.c b/core/wma/src/wma_nan_datapath.c
index 02577a9..8a05a7e 100644
--- a/core/wma/src/wma_nan_datapath.c
+++ b/core/wma/src/wma_nan_datapath.c
@@ -1365,6 +1365,10 @@ send_del_rsp:
 		WMA_LOGD(FL("Sending del rsp to umac (status: %d)"),
 				del_sta->status);
 		wma_send_msg_high_priority(wma, WMA_DELETE_STA_RSP, del_sta, 0);
+	} else {
+		WMA_LOGD(FL("NDI Del Sta resp not needed"));
+		qdf_mem_free(del_sta);
 	}
+
 }
 
diff --git a/core/wma/src/wma_scan_roam.c b/core/wma/src/wma_scan_roam.c
index 5d8b33d..7a77c08 100644
--- a/core/wma/src/wma_scan_roam.c
+++ b/core/wma/src/wma_scan_roam.c
@@ -2522,7 +2522,6 @@ static void wma_roam_update_vdev(tp_wma_handle wma,
 	qdf_mem_copy(wma->interfaces[vdev_id].bssid,
 			roam_synch_ind_ptr->bssid.bytes, IEEE80211_ADDR_LEN);
 	qdf_mem_free(del_bss_params);
-	qdf_mem_free(del_sta_params);
 	qdf_mem_free(set_link_params);
 	qdf_mem_free(add_sta_params);
 }
-- 
cgit v1.1

