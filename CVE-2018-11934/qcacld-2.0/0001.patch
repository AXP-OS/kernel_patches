From 04db58e9e0d6e861fb4ba365784608eb9063efe7 Mon Sep 17 00:00:00 2001
From: Min Liu <minliu@codeaurora.org>
Date: Mon, 13 Aug 2018 16:12:08 +0800
Subject: qcacld-2.0: Process DO_ACS vendor command only in SAP/P2P_GO mode

propagation from qcacld-3.0 to qcacld-2.0

While processing DO_ACS vendor command session context, which is
of type union holds either station's or SAP's session, is updated
without checking adapter's mode. This may lead to corrupt station's
session context if DO_ACS is invoked with station adapter.

Validate adapter mode and process DO_ACS vendor commands only if the
mode is SAP/P2P_GO.

Change-Id: Id882acd5514274a092807995f8eb58c4b5ff7fee
CRs-Fixed: 2295622
---
 CORE/HDD/src/wlan_hdd_cfg80211.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/CORE/HDD/src/wlan_hdd_cfg80211.c b/CORE/HDD/src/wlan_hdd_cfg80211.c
index 1d73400..ed08032 100755
--- a/CORE/HDD/src/wlan_hdd_cfg80211.c
+++ b/CORE/HDD/src/wlan_hdd_cfg80211.c
@@ -9874,6 +9874,13 @@ static int __wlan_hdd_cfg80211_do_acs(struct wiphy *wiphy,
 	if (0 != status)
 		return status;
 
+	if (!((adapter->device_mode == WLAN_HDD_SOFTAP) ||
+	      (adapter->device_mode == WLAN_HDD_P2P_GO))) {
+		hddLog(LOGE, FL("Invalid device mode %d"),
+		       adapter->device_mode);
+		return -EINVAL;
+	}
+
 	if (hdd_cfg_is_static_sub20_channel_width_enabled(hdd_ctx)) {
 		hddLog(LOGE, FL("ACS not support if static sub20 enable"));
 		status = -EINVAL;
-- 
cgit v1.1

