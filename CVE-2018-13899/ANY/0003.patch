From 6efa3feb2471d6411cd44860c81507701d8a1401 Mon Sep 17 00:00:00 2001
From: Darshan Kumsi Srinivasa <darssr@codeaurora.org>
Date: Fri, 12 Oct 2018 14:59:33 +0530
Subject: msm: vidc: ignore processing responses in invalid state

No need to process response messages from video hardware
after device went into invalid state. Processing responses
may result in use-after-free memory fault because client
might free all the resources after error.

Change-Id: I3bfb26e5aa52aba33b7b62cda7820dcbc5fe033f
Signed-off-by: Darshan Kumsi Srinivasa <darssr@codeaurora.org>
---
 drivers/media/platform/msm/vidc/venus_hfi.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/media/platform/msm/vidc/venus_hfi.c b/drivers/media/platform/msm/vidc/venus_hfi.c
index 2acd0d5..7c01a18 100644
--- a/drivers/media/platform/msm/vidc/venus_hfi.c
+++ b/drivers/media/platform/msm/vidc/venus_hfi.c
@@ -3229,6 +3229,12 @@ err_no_work:
 		struct msm_vidc_cb_info *r = &device->response_pkt[i];
 		dprintk(VIDC_DBG, "Processing response %d of %d, type %d\n",
 			(i + 1), num_responses, r->response_type);
+		if (!__core_in_valid_state(device)) {
+			dprintk(VIDC_ERR,
+				"Ignore responses from %d to %d as device is in invalid state",
+				(i + 1), num_responses);
+			break;
+		}
 		device->callback(r->response_type, &r->response);
 	}
 
-- 
cgit v1.1

