From 21b91d4faa275d7b1ae58ad6a549cfa801066dfe Mon Sep 17 00:00:00 2001
From: tfyu <tfyu@codeaurora.org>
Date: Tue, 26 Sep 2017 14:42:31 +0800
Subject: qcacld-2.0: Dump the txrx stat req if the queue is not empty

Dump the txrx stat req if the queue is not empty when detatch the pdev.

Change-Id: Ic38e01668efd28baf55acb04f448e236cc224c79
CRs-Fixed: 2113219
---
 CORE/CLD_TXRX/TXRX/ol_txrx.c | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/CORE/CLD_TXRX/TXRX/ol_txrx.c b/CORE/CLD_TXRX/TXRX/ol_txrx.c
index 6562438..5c0ac76 100644
--- a/CORE/CLD_TXRX/TXRX/ol_txrx.c
+++ b/CORE/CLD_TXRX/TXRX/ol_txrx.c
@@ -889,7 +889,7 @@ A_STATUS ol_txrx_pdev_attach_target(ol_txrx_pdev_handle pdev)
 void
 ol_txrx_pdev_detach(ol_txrx_pdev_handle pdev, int force)
 {
-    int i;
+    int i = 0;
     struct ol_txrx_stats_req_internal *req;
 
     /*checking to ensure txrx pdev structure is not NULL */
@@ -904,9 +904,23 @@ ol_txrx_pdev_detach(ol_txrx_pdev_handle pdev, int force)
     TXRX_ASSERT1(TAILQ_EMPTY(&pdev->vdev_list));
 
     adf_os_spin_lock_bh(&pdev->req_list_spinlock);
+    if (pdev->req_list_depth > 0)
+        TXRX_PRINT(TXRX_PRINT_LEVEL_ERR,
+            "Warning: the txrx req list is not empty, depth=%d\n",
+            pdev->req_list_depth
+            );
     TAILQ_FOREACH(req, &pdev->req_list, req_list_elem) {
         TAILQ_REMOVE(&pdev->req_list, req, req_list_elem);
         pdev->req_list_depth--;
+        TXRX_PRINT(TXRX_PRINT_LEVEL_ERR,
+            "%d: %p,verbose(%d), concise(%d), up_m(0x%x), reset_m(0x%x)\n",
+            i++,
+            req,
+            req->base.print.verbose,
+            req->base.print.concise,
+            req->base.stats_type_upload_mask,
+            req->base.stats_type_reset_mask
+            );
         adf_os_mem_free(req);
     }
     adf_os_spin_unlock_bh(&pdev->req_list_spinlock);
-- 
cgit v1.1

