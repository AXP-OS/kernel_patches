From 95599020931debc4da215f6cc173b01c0f75c4ee Mon Sep 17 00:00:00 2001
From: Harshitha Sai Neelati <hsaine@codeaurora.org>
Date: Tue, 9 Apr 2019 17:41:15 +0530
Subject: msm: kgsl: Bounding the size of allocation to UINT32_MAX

If you provide a large size to gpumem_alloc_id it dives into
dma_alloc region where there exists an integer truncation issue,
which eventually leads to a kernel fault because we try and isolate
a non-cma region of memory

As a fix, we are bounding the allocations to UINT32_MAX, as done
in the newer kernels

Change-Id: Ie0779ecdb77c722d94b06e5518feeca8991fdca1
Signed-off-by: Harshitha Sai Neelati <hsaine@codeaurora.org>
---
 drivers/gpu/msm/kgsl_sharedmem.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/gpu/msm/kgsl_sharedmem.c b/drivers/gpu/msm/kgsl_sharedmem.c
index c306719..6423e26 100644
--- a/drivers/gpu/msm/kgsl_sharedmem.c
+++ b/drivers/gpu/msm/kgsl_sharedmem.c
@@ -1015,6 +1015,9 @@ int kgsl_cma_alloc_secure(struct kgsl_device *device,
 	/* Align size to 1M boundaries */
 	size = ALIGN(size, SZ_1M);
 
+	if (size > UINT_MAX)
+		return -EINVAL;
+
 	memdesc->size = size;
 	memdesc->pagetable = pagetable;
 	memdesc->ops = &kgsl_cma_ops;
-- 
cgit v1.1

