From 50d485b06f838245bbe2480c89d4146630195e21 Mon Sep 17 00:00:00 2001
From: Vijayanand Jitta <vjitta@codeaurora.org>
Date: Wed, 20 Mar 2019 18:30:12 +0530
Subject: mm : retry for reclaim if lmk kill is possible

should_reclaim_retry could result in premature oom if there
are large number of unaccounted(eg: kgsl and ion pages), and
no reclaimable pages, held by positive adj tasks which will be
freed upon lmk kill. so, retry for reclaim when lmk kill is
possible to avoid premature oom.

Change-Id: I7f6be53e3b1ffdf282c74d68a103134c1da9b7cc
Signed-off-by: Vijayanand Jitta <vjitta@codeaurora.org>
---
 mm/page_alloc.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/mm/page_alloc.c b/mm/page_alloc.c
index 32355a0..40151a7 100644
--- a/mm/page_alloc.c
+++ b/mm/page_alloc.c
@@ -3871,9 +3871,13 @@ should_reclaim_retry(gfp_t gfp_mask, unsigned order,
 	 * always increment the no progress counter for them
 	 */
 	if ((did_some_progress || lmk_kill_possible()) &&
-				order <= PAGE_ALLOC_COSTLY_ORDER)
+				order <= PAGE_ALLOC_COSTLY_ORDER) {
+
 		*no_progress_loops = 0;
-	else
+
+		if (lmk_kill_possible())
+			return true;
+	} else
 		(*no_progress_loops)++;
 
 	/*
-- 
cgit v1.1

