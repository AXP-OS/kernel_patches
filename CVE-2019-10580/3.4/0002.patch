From 3858c6408d9cbf65601651cac7f277f47123f3df Mon Sep 17 00:00:00 2001
From: Zhen Kong <zkong@codeaurora.org>
Date: Fri, 20 Sep 2019 13:49:41 -0700
Subject: [PATCH] PARTIAL: qseecom: don't unregister listener when
 data->released is true

Don't unregister listener when data->released is true and only update
listener id in private data when listener is registered successfully,
to avoid unnecessary unregister operation.

Change-Id: I10c3b353ae93a0366d6ea00416cbbe35a6d4ec36
Signed-off-by: Zhen Kong <zkong@codeaurora.org>
Issue: SEC-2475
[Backport to FP2: qseecom_release does not have the check with
free_private_data, so dropping the change around it]
(cherry picked from commit ed418bbe52860d2e86d60996a55393c5aed9f541)
---
 drivers/misc/qseecom.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/drivers/misc/qseecom.c b/drivers/misc/qseecom.c
index 961c1eb6c23..950c80b8c59 100644
--- a/drivers/misc/qseecom.c
+++ b/drivers/misc/qseecom.c
@@ -391,13 +391,13 @@ static int qseecom_register_listener(struct qseecom_dev_handle *data,
 		return -ENOMEM;
 	}
 
-	data->listener.id = rcvd_lstnr.listener_id;
 	init_waitqueue_head(&new_entry->rcv_req_wq);
 
 	spin_lock_irqsave(&qseecom.registered_listener_list_lock, flags);
 	list_add_tail(&new_entry->list, &qseecom.registered_listener_list_head);
 	spin_unlock_irqrestore(&qseecom.registered_listener_list_lock, flags);
 
+	data->listener.id = rcvd_lstnr.listener_id;
 	return ret;
 }
 
@@ -411,6 +411,11 @@ static int qseecom_unregister_listener(struct qseecom_dev_handle *data)
 	struct qseecom_command_scm_resp resp;
 	struct ion_handle *ihandle = NULL;		/* Retrieve phy addr */
 
+	if (data->released) {
+		pr_err("Don't unregister lsnr %d\n", data->listener.id);
+		return -EINVAL;
+	}
+
 	req.qsee_cmd_id = QSEOS_DEREGISTER_LISTENER;
 	req.listener_id = data->listener.id;
 	resp.result = QSEOS_RESULT_INCOMPLETE;
