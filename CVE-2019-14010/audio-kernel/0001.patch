From 1209ddf2dbb00898883ee8c738d465c843819c7e Mon Sep 17 00:00:00 2001
From: Xiaojun Sang <xsang@codeaurora.org>
Date: Thu, 27 Jun 2019 13:57:57 +0800
Subject: dsp: ion: unmap DMA buffer after kernel ion map failure

DMA buffer does not unmap after kernel ion map failure. It leads
to unexpected vaddr and memory leak.

Change-Id: I363dd9178a0bcbca601180bfd0a7bd7ef2430d3e
Signed-off-by: Xiaojun Sang <xsang@codeaurora.org>
---
 dsp/msm_audio_ion.c    | 7 ++++---
 dsp/msm_audio_ion_vm.c | 6 +++---
 2 files changed, 7 insertions(+), 6 deletions(-)

diff --git a/dsp/msm_audio_ion.c b/dsp/msm_audio_ion.c
index 6e75f8d..ae6ba84 100644
--- a/dsp/msm_audio_ion.c
+++ b/dsp/msm_audio_ion.c
@@ -437,6 +437,7 @@ static int msm_audio_ion_map_buf(void *handle, dma_addr_t *paddr,
 	if (rc) {
 		pr_err("%s: ION Get Physical for AUDIO failed, rc = %d\n",
 				__func__, rc);
+		dma_buf_put((struct dma_buf *) handle);
 		goto err;
 	}
 
@@ -444,6 +445,7 @@ static int msm_audio_ion_map_buf(void *handle, dma_addr_t *paddr,
 	if (IS_ERR_OR_NULL(*vaddr)) {
 		pr_err("%s: ION memory mapping for AUDIO failed\n", __func__);
 		rc = -ENOMEM;
+		msm_audio_dma_buf_unmap((struct dma_buf *) handle);
 		goto err;
 	}
 
@@ -514,7 +516,7 @@ int msm_audio_ion_alloc(void **handle, size_t bufsz,
 		if (rc) {
 			pr_err("%s: failed to map ION buf, rc = %d\n", __func__,
 			       rc);
-			dma_buf_put((struct dma_buf*) *handle);
+			goto err;
 		}
 	} else {
 		rc = msm_audio_dma_buf_map(*handle, *vaddr, paddr,
@@ -531,7 +533,6 @@ int msm_audio_ion_alloc(void **handle, size_t bufsz,
 
 	memset(*vaddr, 0, bufsz);
 
-	return rc;
 err:
 	return rc;
 }
@@ -776,7 +777,7 @@ int msm_audio_ion_import(void **handle, int fd,
 	rc = msm_audio_ion_map_buf(*handle, paddr, plen, vaddr);
 	if (rc) {
 		pr_err("%s: failed to map ION buf, rc = %d\n", __func__, rc);
-		goto err_ion_flag;
+		goto err;
 	}
 	pr_debug("%s: mapped address = %pK, size=%zd\n", __func__,
 		*vaddr, bufsz);
diff --git a/dsp/msm_audio_ion_vm.c b/dsp/msm_audio_ion_vm.c
index 7f740af..1b9ca26 100644
--- a/dsp/msm_audio_ion_vm.c
+++ b/dsp/msm_audio_ion_vm.c
@@ -555,6 +555,7 @@ static int msm_audio_ion_map_buf(void *handle, dma_addr_t *paddr,
 	if (rc) {
 		pr_err("%s: ION Get Physical for AUDIO failed, rc = %d\n",
 				__func__, rc);
+		dma_buf_put((struct dma_buf *) handle);
 		goto err;
 	}
 
@@ -562,6 +563,7 @@ static int msm_audio_ion_map_buf(void *handle, dma_addr_t *paddr,
 	if (IS_ERR_OR_NULL(*vaddr)) {
 		pr_err("%s: ION memory mapping for AUDIO failed\n", __func__);
 		rc = -ENOMEM;
+		msm_audio_dma_buf_unmap((struct dma_buf *) handle);
 		goto err;
 	}
 
@@ -632,7 +634,6 @@ int msm_audio_ion_alloc(void **handle, size_t bufsz,
 		if (rc) {
 			pr_err("%s: failed to map ION buf, rc = %d\n", __func__,
 			       rc);
-			dma_buf_put((struct dma_buf*) *handle);
 		}
 	} else {
 		rc = msm_audio_dma_buf_map(*handle, *vaddr, paddr,
@@ -649,7 +650,6 @@ int msm_audio_ion_alloc(void **handle, size_t bufsz,
 
 	memset(*vaddr, 0, bufsz);
 
-	return rc;
 err:
 	return rc;
 }
@@ -707,7 +707,7 @@ int msm_audio_ion_import(void **handle, int fd,
 	rc = msm_audio_ion_map_buf(*handle, paddr, plen, vaddr);
 	if (rc) {
 		pr_err("%s: failed to map ION buf, rc = %d\n", __func__, rc);
-		goto err_ion_flag;
+		goto err;
 	}
 	pr_debug("%s: mapped address = %pK, size=%zd\n", __func__,
 		*vaddr, bufsz);
-- 
cgit v1.1

