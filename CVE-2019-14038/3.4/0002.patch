From c53b5fc7dee746205a305f70fdc6e19c39359a3a Mon Sep 17 00:00:00 2001
From: Soumya Managoli <smanag@codeaurora.org>
Date: Fri, 6 Sep 2019 12:35:58 +0530
Subject: [PATCH] dsp: adm: Fix to avoid memory overread in adm callback

For ADM_CMDRSP_GET_PP_PARAMS_V5 cmd response,
the check for data payload_size is incorrect.
Modify the check condition to make sure there
is enough data to copy, size is contained in
payload[3].

Change-Id: I2f155ad8b302e89131ee85cfc72e4009dda617d3
Signed-off-by: Soumya Managoli <smanag@codeaurora.org>
CVE-2019-14038
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>
---
 sound/soc/msm/qdsp6v2/q6adm.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/sound/soc/msm/qdsp6v2/q6adm.c b/sound/soc/msm/qdsp6v2/q6adm.c
index cd3ca6f8cb1..307c849e864 100644
--- a/sound/soc/msm/qdsp6v2/q6adm.c
+++ b/sound/soc/msm/qdsp6v2/q6adm.c
@@ -648,7 +648,7 @@ static int32_t adm_callback(struct apr_client_data *data, void *priv)
 			/* is big enough and has a valid param size */
 			if ((payload[0] == 0) &&
 			    (data->payload_size > (4 * sizeof(*payload))) &&
-			    (data->payload_size - 4 >= payload[3]) &&
+			    (data->payload_size - (4 * sizeof(*payload)) >= payload[3]) &&
 			    (ARRAY_SIZE(adm_get_parameters) > 0) &&
 			    (ARRAY_SIZE(adm_get_parameters)-1 >= payload[3])) {
 				adm_get_parameters[0] = payload[3] /
