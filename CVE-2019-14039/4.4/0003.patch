From 75546126d510f5c7d40fca850737d1a31ac7cdc0 Mon Sep 17 00:00:00 2001
From: Soumya Managoli <smanag@codeaurora.org>
Date: Fri, 4 Oct 2019 15:52:39 +0530
Subject: [PATCH] msm: adm: Add error check to avoid memory overread

For ADM_CMDRSP_GET_PP_TOPO_MODULE_LIST adsp response,
add additional check to make sure there is enough
data for copy from adsp payload.

Change-Id: Ib8fef116ca73ce68e872616db969f7112f289b69
Signed-off-by: Soumya Managoli <smanag@codeaurora.org>
CVE-2019-14039
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>
---
 sound/soc/msm/qdsp6v2/q6adm.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/sound/soc/msm/qdsp6v2/q6adm.c b/sound/soc/msm/qdsp6v2/q6adm.c
index aaa3b3f3459c..574e26a4c473 100644
--- a/sound/soc/msm/qdsp6v2/q6adm.c
+++ b/sound/soc/msm/qdsp6v2/q6adm.c
@@ -1582,9 +1582,12 @@ static int32_t adm_callback(struct apr_client_data *data, void *priv)
 				pr_err("%s: ADM_CMDRSP_GET_PP_TOPO_MODULE_LIST",
 					 __func__);
 				pr_err(":err = 0x%x\n", payload[0]);
-			} else if (payload[1] >
+			} else if ((payload[1] >
 				   ((ADM_GET_TOPO_MODULE_LIST_LENGTH /
-				   sizeof(uint32_t)) - 1)) {
+				   sizeof(uint32_t)) - 1))  ||
+				   ((data->payload_size -
+				   (2 *  sizeof(uint32_t))) <
+				   (payload[1] * sizeof(uint32_t))))  {
 				pr_err("%s: ADM_CMDRSP_GET_PP_TOPO_MODULE_LIST",
 					 __func__);
 				pr_err(":size = %d\n", payload[1]);
