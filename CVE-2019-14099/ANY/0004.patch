From 21fbc0b4ac1a5009060a6f79fc107182b9b15645 Mon Sep 17 00:00:00 2001
From: E V Ravi <evenka@codeaurora.org>
Date: Mon, 8 Apr 2019 15:19:49 +0530
Subject: msm: ais: Validate packet params against cpu buffer length

Modifying validate packet in cam utils and its callers to provide cpu
buffer length which is used in validation of number of cmd buffers,
io configs and patches.

Change-Id: Ifdb627759befc93e029c4948e630ba6ce63a76ca
Signed-off-by: E V Ravi <evenka@codeaurora.org>
---
 drivers/media/platform/msm/ais/cam_cdm/cam_cdm_virtual_core.c          | 2 +-
 drivers/media/platform/msm/ais/cam_isp/cam_isp_context.c               | 3 ++-
 .../msm/ais/cam_sensor_module/cam_actuator/cam_actuator_core.c         | 1 +
 drivers/media/platform/msm/ais/cam_utils/cam_packet_util.c             | 3 ++-
 4 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/drivers/media/platform/msm/ais/cam_cdm/cam_cdm_virtual_core.c b/drivers/media/platform/msm/ais/cam_cdm/cam_cdm_virtual_core.c
index e5034c5..b257582 100644
--- a/drivers/media/platform/msm/ais/cam_cdm/cam_cdm_virtual_core.c
+++ b/drivers/media/platform/msm/ais/cam_cdm/cam_cdm_virtual_core.c
@@ -120,7 +120,7 @@ int cam_virtual_cdm_submit_bl(struct cam_hw_info *cdm_hw,
 			(len >= cdm_cmd->cmd[i].offset)) {
 
 
-			if ((len - cdm_cmd->cmd[i].offset) <
+			if ((len - cdm_cmd->cmd[i].offset) <=
 				cdm_cmd->cmd[i].len) {
 				CAM_ERR(CAM_CDM, "Not enough buffer");
 				rc = -EINVAL;
diff --git a/drivers/media/platform/msm/ais/cam_isp/cam_isp_context.c b/drivers/media/platform/msm/ais/cam_isp/cam_isp_context.c
index 2c00454..69e3c84 100644
--- a/drivers/media/platform/msm/ais/cam_isp/cam_isp_context.c
+++ b/drivers/media/platform/msm/ais/cam_isp/cam_isp_context.c
@@ -147,7 +147,8 @@ static void cam_isp_ctx_dump_req(struct cam_isp_ctx_req *req_isp)
 			}
 			remain_len = len - req_isp->cfg[i].offset;
 
-			if (req_isp->cfg[i].len > remain_len) {
+			if ((req_isp->cfg[i].len > remain_len) ||
+				(req_isp->cfg[i].len == 0)) {
 				CAM_ERR(CAM_ISP, "Invalid offset");
 				need_put = true;
 			}
diff --git a/drivers/media/platform/msm/ais/cam_sensor_module/cam_actuator/cam_actuator_core.c b/drivers/media/platform/msm/ais/cam_sensor_module/cam_actuator/cam_actuator_core.c
index d9709af..bead7d5 100644
--- a/drivers/media/platform/msm/ais/cam_sensor_module/cam_actuator/cam_actuator_core.c
+++ b/drivers/media/platform/msm/ais/cam_sensor_module/cam_actuator/cam_actuator_core.c
@@ -523,6 +523,7 @@ int32_t cam_actuator_i2c_pkt_parse(struct cam_actuator_ctrl_t *a_ctrl,
 			remain_len = len_of_buff - cmd_desc[i].offset;
 			cmd_buf += cmd_desc[i].offset / sizeof(uint32_t);
 			cmm_hdr = (struct common_header *)cmd_buf;
+			remain_len -= sizeof(struct common_header);
 
 			switch (cmm_hdr->cmd_type) {
 			case CAMERA_SENSOR_CMD_TYPE_I2C_INFO:
diff --git a/drivers/media/platform/msm/ais/cam_utils/cam_packet_util.c b/drivers/media/platform/msm/ais/cam_utils/cam_packet_util.c
index da8c6e3..55dd25e 100644
--- a/drivers/media/platform/msm/ais/cam_utils/cam_packet_util.c
+++ b/drivers/media/platform/msm/ais/cam_utils/cam_packet_util.c
@@ -131,7 +131,7 @@ int cam_packet_util_get_kmd_buffer(struct cam_packet *packet,
 
 	remain_len = len;
 	if (((size_t)cmd_desc->offset >= len) ||
-		((size_t)cmd_desc->size > (len - (size_t)cmd_desc->offset))) {
+		((size_t)cmd_desc->size >= (len - (size_t)cmd_desc->offset))) {
 		CAM_ERR(CAM_UTIL, "invalid memory len:%zd and cmd desc size:%d",
 			len, cmd_desc->size);
 		rc = -EINVAL;
@@ -147,6 +147,7 @@ int cam_packet_util_get_kmd_buffer(struct cam_packet *packet,
 	}
 
 	cpu_addr += (cmd_desc->offset / 4) + (packet->kmd_cmd_buf_offset / 4);
+	remain_len -= packet->kmd_cmd_buf_offset;
 	CAM_DBG(CAM_UTIL, "total size %d, cmd size: %d, KMD buffer size: %d",
 		cmd_desc->size, cmd_desc->length,
 		cmd_desc->size - cmd_desc->length);
-- 
cgit v1.1

