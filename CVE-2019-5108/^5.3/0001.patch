<!DOCTYPE html>
<html lang='en'>
<head>
<title>kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2-0.3.lf.el7'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='http://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='kernel/git/torvalds/linux.git' href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='3e493173b7841259a08c5c8e5cbe90adb349da7e'/><select name='h' onchange='this.form.submit();'>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=3e493173b7841259a08c5c8e5cbe90adb349da7e'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=3e493173b7841259a08c5c8e5cbe90adb349da7e'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3e493173b7841259a08c5c8e5cbe90adb349da7e'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3e493173b7841259a08c5c8e5cbe90adb349da7e'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='3e493173b7841259a08c5c8e5cbe90adb349da7e'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='3e493173b7841259a08c5c8e5cbe90adb349da7e'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td><span class='libravatar'><img class='inline' src='//seccdn.libravatar.org/avatar/78d317fe23eb44614786f97aaf2569eb?s=13&amp;d=retro' /><img class='onhover' src='//seccdn.libravatar.org/avatar/78d317fe23eb44614786f97aaf2569eb?s=128&amp;d=retro' /></span>Jouni Malinen &lt;jouni@codeaurora.org&gt;</td><td class='right'>2019-09-11 16:03:05 +0300</td></tr>
<tr><th>committer</th><td><span class='libravatar'><img class='inline' src='//seccdn.libravatar.org/avatar/81279c43ce60f56aea992763d1ed612b?s=13&amp;d=retro' /><img class='onhover' src='//seccdn.libravatar.org/avatar/81279c43ce60f56aea992763d1ed612b?s=128&amp;d=retro' /></span>David S. Miller &lt;davem@davemloft.net&gt;</td><td class='right'>2019-09-11 14:59:26 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='sha1'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3e493173b7841259a08c5c8e5cbe90adb349da7e'>3e493173b7841259a08c5c8e5cbe90adb349da7e</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=3e493173b7841259a08c5c8e5cbe90adb349da7e'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='sha1'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=3e493173b7841259a08c5c8e5cbe90adb349da7e'>b1531badd43d0d769728ddaccf909303ed109ae2</a></td></tr>
<tr><th>parent</th><td colspan='2' class='sha1'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3dfdecc6d1256835ac0612b2a8f7595466d66327'>3dfdecc6d1256835ac0612b2a8f7595466d66327</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3e493173b7841259a08c5c8e5cbe90adb349da7e&amp;id2=3dfdecc6d1256835ac0612b2a8f7595466d66327'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='sha1'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-3e493173b7841259a08c5c8e5cbe90adb349da7e.tar.gz'>linux-3e493173b7841259a08c5c8e5cbe90adb349da7e.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>mac80211: Do not send Layer 2 Update frame before authorization</div><div class='commit-msg'>The Layer 2 Update frame is used to update bridges when a station roams
to another AP even if that STA does not transmit any frames after the
reassociation. This behavior was described in IEEE Std 802.11F-2003 as
something that would happen based on MLME-ASSOCIATE.indication, i.e.,
before completing 4-way handshake. However, this IEEE trial-use
recommended practice document was published before RSN (IEEE Std
802.11i-2004) and as such, did not consider RSN use cases. Furthermore,
IEEE Std 802.11F-2003 was withdrawn in 2006 and as such, has not been
maintained amd should not be used anymore.

Sending out the Layer 2 Update frame immediately after association is
fine for open networks (and also when using SAE, FT protocol, or FILS
authentication when the station is actually authenticated by the time
association completes). However, it is not appropriate for cases where
RSN is used with PSK or EAP authentication since the station is actually
fully authenticated only once the 4-way handshake completes after
authentication and attackers might be able to use the unauthenticated
triggering of Layer 2 Update frame transmission to disrupt bridge
behavior.

Fix this by postponing transmission of the Layer 2 Update frame from
station entry addition to the point when the station entry is marked
authorized. Similarly, send out the VLAN binding update only if the STA
entry has already been authorized.

Signed-off-by: Jouni Malinen &lt;jouni@codeaurora.org&gt;
Reviewed-by: Johannes Berg &lt;johannes@sipsolutions.net&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3e493173b7841259a08c5c8e5cbe90adb349da7e'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/mac80211/cfg.c?id=3e493173b7841259a08c5c8e5cbe90adb349da7e'>net/mac80211/cfg.c</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 28.6%;'/><td class='rem' style='width: 71.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/mac80211/sta_info.c?id=3e493173b7841259a08c5c8e5cbe90adb349da7e'>net/mac80211/sta_info.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 28.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 71.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 8 insertions, 10 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/mac80211/cfg.c b/net/mac80211/cfg.c<br/>index 111c400199ec..4105c97c7ba1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/mac80211/cfg.c?id=3dfdecc6d1256835ac0612b2a8f7595466d66327'>net/mac80211/cfg.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/mac80211/cfg.c?id=3e493173b7841259a08c5c8e5cbe90adb349da7e'>net/mac80211/cfg.c</a></div><div class='hunk'>@@ -1529,7 +1529,6 @@ static int ieee80211_add_station(struct wiphy *wiphy, struct net_device *dev,</div><div class='ctx'> 	struct sta_info *sta;</div><div class='ctx'> 	struct ieee80211_sub_if_data *sdata;</div><div class='ctx'> 	int err;</div><div class='del'>-	int layer2_update;</div><div class='ctx'> </div><div class='ctx'> 	if (params-&gt;vlan) {</div><div class='ctx'> 		sdata = IEEE80211_DEV_TO_SUB_IF(params-&gt;vlan);</div><div class='hunk'>@@ -1573,18 +1572,12 @@ static int ieee80211_add_station(struct wiphy *wiphy, struct net_device *dev,</div><div class='ctx'> 	    test_sta_flag(sta, WLAN_STA_ASSOC))</div><div class='ctx'> 		rate_control_rate_init(sta);</div><div class='ctx'> </div><div class='del'>-	layer2_update = sdata-&gt;vif.type == NL80211_IFTYPE_AP_VLAN ||</div><div class='del'>-		sdata-&gt;vif.type == NL80211_IFTYPE_AP;</div><div class='del'>-</div><div class='ctx'> 	err = sta_info_insert_rcu(sta);</div><div class='ctx'> 	if (err) {</div><div class='ctx'> 		rcu_read_unlock();</div><div class='ctx'> 		return err;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	if (layer2_update)</div><div class='del'>-		cfg80211_send_layer2_update(sta-&gt;sdata-&gt;dev, sta-&gt;sta.addr);</div><div class='del'>-</div><div class='ctx'> 	rcu_read_unlock();</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='hunk'>@@ -1682,10 +1675,11 @@ static int ieee80211_change_station(struct wiphy *wiphy,</div><div class='ctx'> 		sta-&gt;sdata = vlansdata;</div><div class='ctx'> 		ieee80211_check_fast_xmit(sta);</div><div class='ctx'> </div><div class='del'>-		if (test_sta_flag(sta, WLAN_STA_AUTHORIZED))</div><div class='add'>+		if (test_sta_flag(sta, WLAN_STA_AUTHORIZED)) {</div><div class='ctx'> 			ieee80211_vif_inc_num_mcast(sta-&gt;sdata);</div><div class='del'>-</div><div class='del'>-		cfg80211_send_layer2_update(sta-&gt;sdata-&gt;dev, sta-&gt;sta.addr);</div><div class='add'>+			cfg80211_send_layer2_update(sta-&gt;sdata-&gt;dev,</div><div class='add'>+						    sta-&gt;sta.addr);</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	err = sta_apply_parameters(local, sta, params);</div><div class='head'>diff --git a/net/mac80211/sta_info.c b/net/mac80211/sta_info.c<br/>index 95eb8220e2e4..5fb368cc2633 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/mac80211/sta_info.c?id=3dfdecc6d1256835ac0612b2a8f7595466d66327'>net/mac80211/sta_info.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/mac80211/sta_info.c?id=3e493173b7841259a08c5c8e5cbe90adb349da7e'>net/mac80211/sta_info.c</a></div><div class='hunk'>@@ -1979,6 +1979,10 @@ int sta_info_move_state(struct sta_info *sta,</div><div class='ctx'> 			ieee80211_check_fast_xmit(sta);</div><div class='ctx'> 			ieee80211_check_fast_rx(sta);</div><div class='ctx'> 		}</div><div class='add'>+		if (sta-&gt;sdata-&gt;vif.type == NL80211_IFTYPE_AP_VLAN ||</div><div class='add'>+		    sta-&gt;sdata-&gt;vif.type == NL80211_IFTYPE_AP)</div><div class='add'>+			cfg80211_send_layer2_update(sta-&gt;sdata-&gt;dev,</div><div class='add'>+						    sta-&gt;sta.addr);</div><div class='ctx'> 		break;</div><div class='ctx'> 	default:</div><div class='ctx'> 		break;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2-0.3.lf.el7</a> (<a href='https://git-scm.com/'>git 2.18.0</a>) at 2020-01-27 01:51:04 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
