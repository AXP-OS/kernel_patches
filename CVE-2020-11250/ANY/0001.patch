From 827c2fcadb0569bd94bdff386483fb404145687b Mon Sep 17 00:00:00 2001
From: Jeya R <jeyr@codeaurora.org>
Date: Tue, 11 Aug 2020 12:26:06 +0530
Subject: msm: adsprpc: Avoid race condition during map find and free

Protect remote heap buffer list with spin lock while freeing
to avoid UAF in fastrpc_mmap_find() on a buffer that is freed
in fastrpc_mmap_free().

Change-Id: I524abf80087a5a53dfdf81c81ef34cd13f6a43cb
Acked-by: Maitreyi Gupta <maitreyi@qti.qualcomm.com>
Signed-off-by: jeyr <jeyr@codeaurora.org>
---
 drivers/char/adsprpc.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/char/adsprpc.c b/drivers/char/adsprpc.c
index 7dd63f5..ef2180c9 100644
--- a/drivers/char/adsprpc.c
+++ b/drivers/char/adsprpc.c
@@ -730,9 +730,11 @@ static void fastrpc_mmap_free(struct fastrpc_mmap *map, uint32_t flags)
 	}
 	if (map->flags == ADSP_MMAP_HEAP_ADDR ||
 				map->flags == ADSP_MMAP_REMOTE_HEAP_ADDR) {
+		spin_lock(&me->hlock);
 		map->refs--;
 		if (!map->refs)
 			hlist_del_init(&map->hn);
+		spin_unlock(&me->hlock);
 		if (map->refs > 0)
 			return;
 	} else {
-- 
cgit v1.1

