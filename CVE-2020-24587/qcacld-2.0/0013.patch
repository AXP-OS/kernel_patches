From 061934a99aae0f3bbf1597be1476eae8bf13c33d Mon Sep 17 00:00:00 2001
From: Tiger Yu <tfyu@codeaurora.org>
Date: Mon, 8 Feb 2021 14:58:31 +0800
Subject: qcacld-2.0: Flush RX packets for peer after key installation

Rx packets including fragments are not flushed as part of rekey which
could result in fragments encrypted under different keys to be
reassembled.

Fix is to flush all rx pakcets including fragments for the peer after
key installation.

Change-Id: I80b680040ceab687d0e5ee01c21582d8873a773b
CRs-Fixed: 2867975
---
 CORE/SERVICES/WMA/wma.c | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/CORE/SERVICES/WMA/wma.c b/CORE/SERVICES/WMA/wma.c
index 00db076..70fef91 100644
--- a/CORE/SERVICES/WMA/wma.c
+++ b/CORE/SERVICES/WMA/wma.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2013-2018 The Linux Foundation. All rights reserved.
+ * Copyright (c) 2013-2018, 2021 The Linux Foundation. All rights reserved.
  *
  * Previously licensed under the ISC license by Qualcomm Atheros, Inc.
  *
@@ -113,6 +113,7 @@
 #include "wma_nan_datapath.h"
 #include "adf_trace.h"
 
+#include "ol_rx_reorder.h"
 /* ################### defines ################### */
 /*
  * TODO: Following constant should be shared by firwmare in
@@ -20351,6 +20352,12 @@ static void wma_set_stakey(tp_wma_handle wma_handle, tpSetStaKeyParams key_info)
 		}
 	}
 
+        WMA_LOGD("%s: QSV2020002, vid(%u), rx cleanup for peer(%pM) after key install",
+            __func__,
+            txrx_vdev->vdev_id,
+            peer->mac_addr.raw);
+        ol_rx_reorder_peer_cleanup(txrx_vdev, peer);
+
         /* In IBSS mode, set the BSS KEY for this peer
          ** BSS key is supposed to be cache into wma_handle
         */
-- 
cgit v1.1

