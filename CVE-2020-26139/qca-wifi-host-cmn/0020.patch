From 4d9d43c405db53c715985259ea0ab2b401b1684b Mon Sep 17 00:00:00 2001
From: Varsha Mishra <varsham@codeaurora.org>
Date: Wed, 10 Mar 2021 18:28:06 +0530
Subject: qcacmn: Drop non-eapol packet in error path

Until peer is authorized, drop non-eapol frames
in rx error path.

Change-Id: I339b9248b8ae63e4b6ab0268c4ed28130404ba33
---
 dp/wifi3.0/dp_rx_err.c | 19 +++++++++++++++++--
 1 file changed, 17 insertions(+), 2 deletions(-)

diff --git a/dp/wifi3.0/dp_rx_err.c b/dp/wifi3.0/dp_rx_err.c
index dd41d47..28d3fa9 100644
--- a/dp/wifi3.0/dp_rx_err.c
+++ b/dp/wifi3.0/dp_rx_err.c
@@ -814,6 +814,22 @@ dp_rx_null_q_desc_handle(struct dp_soc *soc, qdf_nbuf_t nbuf,
 			/* IEEE80211_SEQ_MAX indicates invalid start_seq */
 	}
 
+	eh = (qdf_ether_header_t *)qdf_nbuf_data(nbuf);
+
+	if (peer && !peer->authorize) {
+		bool is_eapol = qdf_nbuf_is_ipv4_eapol_pkt(nbuf) ||
+				qdf_nbuf_is_ipv4_wapi_pkt(nbuf);
+
+		bool is_not_match = qdf_mem_cmp(eh->ether_dhost,
+						&vdev->mac_addr.raw[0],
+						QDF_MAC_ADDR_SIZE);
+
+		if (!is_eapol)
+			goto drop_nbuf;
+		else if(is_not_match)
+			goto drop_nbuf;
+	}
+
 	/*
 	 * Drop packets in this path if cce_match is found. Packets will come
 	 * in following path depending on whether tidQ is setup.
@@ -827,8 +843,7 @@ dp_rx_null_q_desc_handle(struct dp_soc *soc, qdf_nbuf_t nbuf,
 	 *    to stack.
 	 */
 	if (qdf_unlikely(dp_rx_err_cce_drop(soc, vdev, nbuf, rx_tlv_hdr))) {
-		qdf_nbuf_free(nbuf);
-		return QDF_STATUS_E_FAILURE;
+		goto drop_nbuf;
 	}
 
 	if (qdf_unlikely(vdev->rx_decap_type == htt_cmn_pkt_type_raw)) {
-- 
cgit v1.1

