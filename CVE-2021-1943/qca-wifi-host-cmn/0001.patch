From 67129820f7352fbf96415e632f7cd746bfbc6185 Mon Sep 17 00:00:00 2001
From: Jyoti Kumari <jyotkuma@codeaurora.org>
Date: Fri, 18 Dec 2020 22:58:32 +0530
Subject: qcacmn: Fix out of bound read issue in util_scan_parse_rnr_ie()

During ie parse from beacon/probe response, the variable
tbtt_count and tbtt_length in util_scan_parse_rnr_ie() getting
read from ie and the value is not checked before using it which
may cause out of bound read issue

Validate tbtt_count and tbtt_length before using it

Change-Id: I51cfb2356fb16feda8a70c4b76c7f76c90b1393b
CRs-Fixed: 2836205
---
 umac/scan/dispatcher/inc/wlan_scan_public_structs.h | 1 +
 umac/scan/dispatcher/src/wlan_scan_utils_api.c      | 7 ++++++-
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/umac/scan/dispatcher/inc/wlan_scan_public_structs.h b/umac/scan/dispatcher/inc/wlan_scan_public_structs.h
index b9d97f0..347617a 100644
--- a/umac/scan/dispatcher/inc/wlan_scan_public_structs.h
+++ b/umac/scan/dispatcher/inc/wlan_scan_public_structs.h
@@ -87,6 +87,7 @@ typedef uint32_t wlan_scan_id;
 	WLAN_GET_BITS(value32, (8 * (bw_index)), 8)
 #define WLAN_SET_SCORE_PERCENTAGE(value32, score_pcnt, bw_index) \
 	WLAN_SET_BITS(value32, (8 * (bw_index)), 8, score_pcnt)
+#define TBTT_INFO_COUNT 16
 
 /* forward declaration */
 struct wlan_objmgr_vdev;
diff --git a/umac/scan/dispatcher/src/wlan_scan_utils_api.c b/umac/scan/dispatcher/src/wlan_scan_utils_api.c
index fe269cc..95738ab 100644
--- a/umac/scan/dispatcher/src/wlan_scan_utils_api.c
+++ b/umac/scan/dispatcher/src/wlan_scan_utils_api.c
@@ -687,7 +687,12 @@ util_scan_parse_rnr_ie(struct scan_cache_entry *scan_entry,
 		scm_debug("tbtt_count %d, tbtt_length %d, fieldtype %d",
 			  tbtt_count, tbtt_length, fieldtype);
 		data += sizeof(struct neighbor_ap_info_field);
-		for (i = 0; i < (tbtt_count + 1) ; i++) {
+
+		if (tbtt_count > TBTT_INFO_COUNT)
+			break;
+
+		for (i = 0; i < (tbtt_count + 1) &&
+		     data < ((uint8_t *)ie + rnr_ie_len + 2); i++) {
 			if (i < MAX_RNR_BSS)
 				util_scan_update_rnr(
 					&scan_entry->rnr.bss_info[i],
-- 
cgit v1.1

