From a637a43b7995cf905f1d0d059b418ee57e60aa67 Mon Sep 17 00:00:00 2001
From: Puranam V G Tejaswi <pvgtejas@codeaurora.org>
Date: Thu, 31 Dec 2020 12:25:28 +0530
Subject: msm: kgsl: Use pid struct to find the process to reclaim

Use pid struct instead of tgid to find the correct process private
to be used for reclaim to avoid any sort of issues related to pid reuse.

Change-Id: Ifea6583fb24c6c623d54312865b3fd584ee9fd26
Signed-off-by: Puranam V G Tejaswi <pvgtejas@codeaurora.org>
---
 drivers/gpu/msm/kgsl_reclaim.c | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/msm/kgsl_reclaim.c b/drivers/gpu/msm/kgsl_reclaim.c
index 443525d..30d9bfb 100644
--- a/drivers/gpu/msm/kgsl_reclaim.c
+++ b/drivers/gpu/msm/kgsl_reclaim.c
@@ -196,12 +196,21 @@ ssize_t kgsl_proc_max_reclaim_limit_show(struct device *dev,
 static int kgsl_reclaim_callback(struct notifier_block *nb,
 		unsigned long pid, void *data)
 {
-	struct kgsl_process_private *process;
+	struct kgsl_process_private *p, *process = NULL;
 	struct kgsl_mem_entry *entry;
 	struct kgsl_memdesc *memdesc;
 	int valid_entry, next = 0, ret;
 
-	process = kgsl_process_private_find(pid);
+	spin_lock(&kgsl_driver.proclist_lock);
+	list_for_each_entry(p, &kgsl_driver.process_list, list) {
+		if ((unsigned long)p->pid == pid) {
+			if (kgsl_process_private_get(p))
+				process = p;
+			break;
+		}
+	}
+	spin_unlock(&kgsl_driver.proclist_lock);
+
 	if (!process)
 		return NOTIFY_OK;
 
-- 
cgit v1.1

