From d7decdff0cfd9f5a36763ae4f3f667e67042ba8f Mon Sep 17 00:00:00 2001
From: Liangwei Dong <liangwei@codeaurora.org>
Date: Mon, 10 May 2021 09:50:53 +0800
Subject: qcacld-2.0: Fix integer underflow in assoc response frame

propagation from qcacld-3.0 to qcacld-2.0

In func aead_decrypt_assoc_rsp(), it calls
find_ie_data_after_fils_session_ie() to find IE pointer after
FILS session IE from the frame payload.
There is possibility of integer underflow if frame payload length is
less than FIXED_PARAM_OFFSET_ASSOC_RSP which may increase value
of buf_len variable in find_ie_data_after_fils_session_ie() and
cause OOB during parsing process.
Validate frame payload length with FIXED_PARAM_OFFSET_ASSOC_RSP,
if it is less then return failure.

Change-Id: I78fbcfeaa1058fcf2a6fe47cd5c26390b54974af
CRs-Fixed: 2940789
---
 CORE/MAC/src/pe/lim/lim_process_fils.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/CORE/MAC/src/pe/lim/lim_process_fils.c b/CORE/MAC/src/pe/lim/lim_process_fils.c
index 05a8567..91c3361 100644
--- a/CORE/MAC/src/pe/lim/lim_process_fils.c
+++ b/CORE/MAC/src/pe/lim/lim_process_fils.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2017-2019 The Linux Foundation. All rights reserved.
+ * Copyright (c) 2017-2019, 2021 The Linux Foundation. All rights reserved.
  *
  * Permission to use, copy, modify, and/or distribute this software for
  * any purpose with or without fee is hereby granted, provided that the
@@ -1859,6 +1859,12 @@ VOS_STATUS aead_decrypt_assoc_rsp(tpAniSirGlobal mac_ctx,
 	uint8_t *fils_ies;
 	struct pe_fils_session *fils_info = (session->fils_info);
 
+	if (*n_frame < FIXED_PARAM_OFFSET_ASSOC_RSP) {
+		limLog(mac_ctx, LOGE,
+		       FL("payload len is less than ASSOC RES offset"));
+		return VOS_STATUS_E_FAILURE;
+	}
+
 	lim_fils_data_dump("Assoc Rsp :", p_frame, *n_frame);
 	status = find_ie_data_after_fils_session_ie(mac_ctx, p_frame +
 			FIXED_PARAM_OFFSET_ASSOC_RSP,
-- 
cgit v1.1

