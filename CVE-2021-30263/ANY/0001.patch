From 593570700ed6c01c1d4c2997319adeed0179bfc9 Mon Sep 17 00:00:00 2001
From: Praveen Kurapati <pkurapat@codeaurora.org>
Date: Wed, 29 Jan 2020 14:56:35 +0530
Subject: msm: ipa4: Fix race condition in adpl pipe open

Observing race condition during odl pipe open
simultaneously. Add changes to protect the scenario
with mutex lock.

Change-Id: Ib79df57fe871ed8ce8ce480589a93235d030cba0
Signed-off-by: Praveen Kurapati <pkurapat@codeaurora.org>
---
 drivers/platform/msm/ipa/ipa_v3/ipa_odl.c | 7 ++++++-
 drivers/platform/msm/ipa/ipa_v3/ipa_odl.h | 3 ++-
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/drivers/platform/msm/ipa/ipa_v3/ipa_odl.c b/drivers/platform/msm/ipa/ipa_v3/ipa_odl.c
index 3b85558..bf3a273 100644
--- a/drivers/platform/msm/ipa/ipa_v3/ipa_odl.c
+++ b/drivers/platform/msm/ipa/ipa_v3/ipa_odl.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2018-2020, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2018-2021, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -425,6 +425,7 @@ static int ipa_adpl_open(struct inode *inode, struct file *filp)
 	int ret = 0;
 
 	IPADBG("Called the function :\n");
+	mutex_lock(&ipa3_odl_ctx->pipe_lock);
 	if (ipa3_odl_ctx->odl_state.odl_init &&
 				!ipa3_odl_ctx->odl_state.adpl_open) {
 		/* Activate ipa_pm*/
@@ -438,6 +439,7 @@ static int ipa_adpl_open(struct inode *inode, struct file *filp)
 		print_ipa_odl_state_bit_mask();
 		ret = -ENODEV;
 	}
+	mutex_unlock(&ipa3_odl_ctx->pipe_lock);
 
 	return ret;
 }
@@ -446,6 +448,7 @@ static int ipa_adpl_release(struct inode *inode, struct file *filp)
 {
 	int ret = 0;
 	/* Deactivate ipa_pm */
+	mutex_lock(&ipa3_odl_ctx->pipe_lock);
 	ret = ipa_pm_deactivate_sync(ipa3_odl_ctx->odl_pm_hdl);
 	if (ret)
 		IPAERR("failed to activate pm\n");
@@ -458,6 +461,7 @@ static int ipa_adpl_release(struct inode *inode, struct file *filp)
 			IPAERR("mpm failed to disable ADPL over ODL\n");
 
 	}
+	mutex_unlock(&ipa3_odl_ctx->pipe_lock);
 
 	return ret;
 }
@@ -676,6 +680,7 @@ int ipa_odl_init(void)
 	odl_cdev = ipa3_odl_ctx->odl_cdev;
 	INIT_LIST_HEAD(&ipa3_odl_ctx->adpl_msg_list);
 	mutex_init(&ipa3_odl_ctx->adpl_msg_lock);
+	mutex_init(&ipa3_odl_ctx->pipe_lock);
 
 	odl_cdev[loop].class = class_create(THIS_MODULE, "ipa_adpl");
 
diff --git a/drivers/platform/msm/ipa/ipa_v3/ipa_odl.h b/drivers/platform/msm/ipa/ipa_v3/ipa_odl.h
index 6effa1b..2964bc7 100644
--- a/drivers/platform/msm/ipa/ipa_v3/ipa_odl.h
+++ b/drivers/platform/msm/ipa/ipa_v3/ipa_odl.h
@@ -1,4 +1,4 @@
-/* Copyright (c) 2018-2020, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2018-2021, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -58,6 +58,7 @@ struct ipa_odl_context {
 	struct ipa3_odl_char_device_context odl_cdev[2];
 	struct list_head adpl_msg_list;
 	struct mutex adpl_msg_lock;
+	struct mutex pipe_lock;
 	struct ipa_sys_connect_params odl_sys_param;
 	u32 odl_client_hdl;
 	struct odl_state_bit_mask odl_state;
-- 
cgit v1.1

