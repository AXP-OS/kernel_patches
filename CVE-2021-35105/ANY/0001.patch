From a134f476741492666ac75fd9dc14ed0f9d589d6e Mon Sep 17 00:00:00 2001
From: Kamal Agrawal <kamaagra@codeaurora.org>
Date: Tue, 28 Sep 2021 15:28:03 +0530
Subject: msm: kgsl: Fix out of bound write in adreno_profile_submit_time

Make sure there is enough room in the memory descriptor to store the
entire profiling buffer object.

Change-Id: I1e1c73097bb2bba9645b0a3c66fdbbc71d8ba8fa
Signed-off-by: Kamal Agrawal <kamaagra@codeaurora.org>
---
 drivers/gpu/msm/kgsl_cmdbatch.c | 34 +++++++++++-----------------------
 1 file changed, 11 insertions(+), 23 deletions(-)

diff --git a/drivers/gpu/msm/kgsl_cmdbatch.c b/drivers/gpu/msm/kgsl_cmdbatch.c
index 03a6acc..9c6adda 100644
--- a/drivers/gpu/msm/kgsl_cmdbatch.c
+++ b/drivers/gpu/msm/kgsl_cmdbatch.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2008-2017, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2008-2017,2021, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -538,6 +538,7 @@ static void add_profiling_buffer(struct kgsl_device *device,
 		unsigned int id, uint64_t offset)
 {
 	struct kgsl_mem_entry *entry;
+	u64 start;
 
 	if (!(cmdbatch->flags & KGSL_CMDBATCH_PROFILING))
 		return;
@@ -554,7 +555,14 @@ static void add_profiling_buffer(struct kgsl_device *device,
 			gpuaddr);
 
 	if (entry != NULL) {
-		if (!kgsl_gpuaddr_in_memdesc(&entry->memdesc, gpuaddr, size)) {
+		start = id ? (entry->memdesc.gpuaddr + offset) : gpuaddr;
+		/*
+		 * Make sure there is enough room in the object to store the
+		 * entire profiling buffer object
+		 */
+		if (!kgsl_gpuaddr_in_memdesc(&entry->memdesc, gpuaddr, size) ||
+			!kgsl_gpuaddr_in_memdesc(&entry->memdesc, start,
+				sizeof(struct kgsl_cmdbatch_profiling_buffer))) {
 			kgsl_mem_entry_put(entry);
 			entry = NULL;
 		}
@@ -567,27 +575,7 @@ static void add_profiling_buffer(struct kgsl_device *device,
 		return;
 	}
 
-	if (!id) {
-		cmdbatch->profiling_buffer_gpuaddr = gpuaddr;
-	} else {
-		u64 off =
-			offset + sizeof(struct kgsl_cmdbatch_profiling_buffer);
-
-		/*
-		 * Make sure there is enough room in the object to store the
-		 * entire profiling buffer object
-		 */
-		if (off < offset || off >= entry->memdesc.size) {
-			dev_err(device->dev,
-				"ignore invalid profile offset ctxt %d id %d offset %lld gpuaddr %llx size %lld\n",
-			cmdbatch->context->id, id, offset, gpuaddr, size);
-			kgsl_mem_entry_put(entry);
-			return;
-		}
-
-		cmdbatch->profiling_buffer_gpuaddr =
-			entry->memdesc.gpuaddr + offset;
-	}
+	cmdbatch->profiling_buffer_gpuaddr = start;
 	cmdbatch->profiling_buf_entry = entry;
 }
 
-- 
cgit v1.1

