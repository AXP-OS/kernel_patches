From 44cda6053e652e819af6f5fdd52cee9698a8ee68 Mon Sep 17 00:00:00 2001
From: Rupesh Tatiya <rtatiya@codeaurora.org>
Date: Tue, 16 Feb 2016 16:07:11 +0530
Subject: [PATCH] radio-iris: fix memory leak issue for hci dev

On FM closure, free the memory allocated for hci device. Make the
register/unregister call symmetric. Also, do not free the video device on
FM closure as it is allocated in platform driver probe and removed in
remove call.

CRs-Fixed: 981131
Change-Id: Ibc5d287083572ab1686a91cc7b934ae66f749e27
Signed-off-by: Rupesh Tatiya <rtatiya@codeaurora.org>
---
 drivers/media/radio/radio-iris-transport.c | 4 ++++
 drivers/media/radio/radio-iris.c           | 2 --
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/media/radio/radio-iris-transport.c b/drivers/media/radio/radio-iris-transport.c
index 0110deffddc..cd2013288b0 100644
--- a/drivers/media/radio/radio-iris-transport.c
+++ b/drivers/media/radio/radio-iris-transport.c
@@ -201,6 +201,10 @@ static int radio_hci_smd_register_dev(struct radio_data *hsmd)
 
 static void radio_hci_smd_deregister(void)
 {
+	radio_hci_unregister_dev(hs.hdev);
+	kfree(hs.hdev);
+	hs.hdev = NULL;
+
 	smd_close(hs.fm_channel);
 	hs.fm_channel = 0;
 	fmsmd_set = 0;
diff --git a/drivers/media/radio/radio-iris.c b/drivers/media/radio/radio-iris.c
index 07f38797f6d..4607a3275e1 100644
--- a/drivers/media/radio/radio-iris.c
+++ b/drivers/media/radio/radio-iris.c
@@ -630,8 +630,6 @@ int radio_hci_unregister_dev(struct radio_hci_dev *hdev)
 	skb_queue_purge(&hdev->rx_q);
 	skb_queue_purge(&hdev->cmd_q);
 	skb_queue_purge(&hdev->raw_q);
-	kfree(radio->fm_hdev);
-	kfree(radio->videodev);
 
 	return 0;
 }
