From 35095c2021878b6cf7818e6071bd4193006c9da9 Mon Sep 17 00:00:00 2001
From: Rupesh Tatiya <rtatiya@codeaurora.org>
Date: Thu, 24 Mar 2016 16:03:24 +0530
Subject: [PATCH] radio-iris: Perform smd close operation only once

iris_fops_release function can be called in parallel and this may result in
accessing freed memory in close_smd operation. Serialize the access to
close_smd and call it only if it is valid.

Change-Id: I9dd00625866c2f0da12ae0d35896f0683bd1453f
Signed-off-by: Rupesh Tatiya <rtatiya@codeaurora.org>
---
 drivers/media/radio/radio-iris.c | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/media/radio/radio-iris.c b/drivers/media/radio/radio-iris.c
index 96ce16b25b0..34f3749af36 100644
--- a/drivers/media/radio/radio-iris.c
+++ b/drivers/media/radio/radio-iris.c
@@ -632,6 +632,7 @@ int radio_hci_unregister_dev(struct radio_hci_dev *hdev)
 	skb_queue_purge(&hdev->cmd_q);
 	skb_queue_purge(&hdev->raw_q);
 
+	radio->fm_hdev = NULL;
 	return 0;
 }
 EXPORT_SYMBOL(radio_hci_unregister_dev);
@@ -5195,11 +5196,11 @@ static int iris_fops_release(struct file *file)
 		return retval;
 	}
 END:
-	if (radio->fm_hdev != NULL) {
-		mutex_lock(&fm_smd_enable);
+	mutex_lock(&fm_smd_enable);
+	if (radio->fm_hdev != NULL)
 		radio->fm_hdev->close_smd();
-		mutex_unlock(&fm_smd_enable);
-	}
+	mutex_unlock(&fm_smd_enable);
+
 	if (retval < 0)
 		FMDERR("Err on disable FM %d\n", retval);
 
