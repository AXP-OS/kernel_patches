From e0bf93ad5c1f935d795fdccfea3cb1c5c6989a8c Mon Sep 17 00:00:00 2001
From: Luca Weiss <luca.weiss@fairphone.com>
Date: Wed, 18 Aug 2021 17:24:20 +0200
Subject: [PATCH] camera: rate limit some error messages

Our kernel doesn't like log spam.

Issue: SEC-2082
Test: run sts-engbuild-no-spl-lock -m StsHostTestCases -t android.security.sts.Poc17_01#testPocCVE_2016_8412
Change-Id: I85455ec68ad57c0c4ba5f9de5e4d87fadcdf2adf
---
 .../platform/msm/camera_v2/sensor/actuator/msm_actuator.c      | 3 ++-
 drivers/media/platform/msm/camera_v2/sensor/cci/msm_cci.c      | 3 ++-
 .../platform/msm/camera_v2/sensor/io/msm_camera_cci_i2c.c      | 3 ++-
 3 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/drivers/media/platform/msm/camera_v2/sensor/actuator/msm_actuator.c b/drivers/media/platform/msm/camera_v2/sensor/actuator/msm_actuator.c
index cfbc9cf6ab8..3de6e961c43 100644
--- a/drivers/media/platform/msm/camera_v2/sensor/actuator/msm_actuator.c
+++ b/drivers/media/platform/msm/camera_v2/sensor/actuator/msm_actuator.c
@@ -13,6 +13,7 @@
 #define pr_fmt(fmt) "%s:%d " fmt, __func__, __LINE__
 
 #include <linux/module.h>
+#include <linux/ratelimit.h>
 #include "msm_sd.h"
 #include "msm_actuator.h"
 #include "msm_cci.h"
@@ -873,7 +874,7 @@ static int msm_actuator_close(struct v4l2_subdev *sd,
 		rc = a_ctrl->i2c_client.i2c_func_tbl->i2c_util(
 			&a_ctrl->i2c_client, MSM_CCI_RELEASE);
 		if (rc < 0)
-			pr_err("cci_init failed\n");
+			pr_err_ratelimited("cci_init failed\n");
 	}
 	kfree(a_ctrl->i2c_reg_tbl);
 	a_ctrl->i2c_reg_tbl = NULL;
diff --git a/drivers/media/platform/msm/camera_v2/sensor/cci/msm_cci.c b/drivers/media/platform/msm/camera_v2/sensor/cci/msm_cci.c
index 9e5fa7fcef6..2ad496ff475 100644
--- a/drivers/media/platform/msm/camera_v2/sensor/cci/msm_cci.c
+++ b/drivers/media/platform/msm/camera_v2/sensor/cci/msm_cci.c
@@ -17,6 +17,7 @@
 #include <linux/of.h>
 #include <linux/of_gpio.h>
 #include <linux/of_platform.h>
+#include <linux/ratelimit.h>
 #include <media/msm_isp.h>
 #include "msm_sd.h"
 #include "msm_cci.h"
@@ -774,7 +775,7 @@ static int32_t msm_cci_release(struct v4l2_subdev *sd)
 	cci_dev = v4l2_get_subdevdata(sd);
 
 	if (!cci_dev->ref_count || cci_dev->cci_state != CCI_STATE_ENABLED) {
-		pr_err("%s invalid ref count %d / cci state %d\n",
+		pr_err_ratelimited("%s invalid ref count %d / cci state %d\n",
 			__func__, cci_dev->ref_count, cci_dev->cci_state);
 		return -EINVAL;
 	}
diff --git a/drivers/media/platform/msm/camera_v2/sensor/io/msm_camera_cci_i2c.c b/drivers/media/platform/msm/camera_v2/sensor/io/msm_camera_cci_i2c.c
index 497395575ae..71c32ff8768 100644
--- a/drivers/media/platform/msm/camera_v2/sensor/io/msm_camera_cci_i2c.c
+++ b/drivers/media/platform/msm/camera_v2/sensor/io/msm_camera_cci_i2c.c
@@ -10,6 +10,7 @@
  * GNU General Public License for more details.
  */
 
+#include <linux/ratelimit.h>
 #include <mach/camera2.h>
 #include "msm_camera_i2c.h"
 #include "msm_cci.h"
@@ -519,7 +520,7 @@ int32_t msm_sensor_cci_i2c_util(struct msm_camera_i2c_client *client,
 	rc = v4l2_subdev_call(client->cci_client->cci_subdev,
 			core, ioctl, VIDIOC_MSM_CCI_CFG, &cci_ctrl);
 	if (rc < 0) {
-		pr_err("%s line %d rc = %d\n", __func__, __LINE__, rc);
+		pr_err_ratelimited("%s line %d rc = %d\n", __func__, __LINE__, rc);
 		return rc;
 	}
 	return cci_ctrl.status;
