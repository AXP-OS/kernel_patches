From 454df2f458aeaa9912e10e8017cf7907e6983ffa Mon Sep 17 00:00:00 2001
From: google <android@google.com>
Date: Mon, 4 Dec 2017 14:24:17 -0800
Subject: [PATCH] qcacld-2.0: Add check for set_ft_ies buffer length

qcacld-3.0 to qcacld-2.0 propagation

Add check for buffer length in function sme_set_ft_ies.

Bug: 64431968

Change-Id: I7adc56e23316c0ceb193a5bdf8c4c0b5f4fbd20a
CRs-Fixed: 2070583
Signed-off-by: Ecco Park <eccopark@google.com>
Fix CVE-2017-11035
---
 drivers/staging/prima/CORE/HDD/src/wlan_hdd_wext.c        | 5 ++++-
 drivers/staging/prima/CORE/SME/src/sme_common/sme_FTApi.c | 6 ++----
 2 files changed, 6 insertions(+), 5 deletions(-)

diff --git a/drivers/staging/prima/CORE/HDD/src/wlan_hdd_wext.c b/drivers/staging/prima/CORE/HDD/src/wlan_hdd_wext.c
index e2e49b6f859f..0fca512e6d92 100644
--- a/drivers/staging/prima/CORE/HDD/src/wlan_hdd_wext.c
+++ b/drivers/staging/prima/CORE/HDD/src/wlan_hdd_wext.c
@@ -7073,7 +7073,10 @@ static const struct iw_priv_args we_private_args[] = {
         WLAN_GET_LINK_SPEED,
         IW_PRIV_TYPE_CHAR | 18,
         IW_PRIV_TYPE_CHAR | 5, "getLinkSpeed" },
-   
+    {
+		WLAN_PRIV_SET_FTIES,
+		IW_PRIV_TYPE_CHAR | MAX_FTIE_SIZE,
+		0, "set_ft_ies" },
 };
 
 
diff --git a/drivers/staging/prima/CORE/SME/src/sme_common/sme_FTApi.c b/drivers/staging/prima/CORE/SME/src/sme_common/sme_FTApi.c
index 929592b9d163..56eecb50fd24 100644
--- a/drivers/staging/prima/CORE/SME/src/sme_common/sme_FTApi.c
+++ b/drivers/staging/prima/CORE/SME/src/sme_common/sme_FTApi.c
@@ -175,6 +175,7 @@ void sme_SetFTIEs( tHalHandle hHal, tANI_U8 sessionId, const tANI_U8 *ft_ies,
     {
         case eFT_START_READY:
         case eFT_AUTH_REQ_READY:
+			smsLog( pMac, LOG1, FL("ft_ies_length: %d"), ft_ies_length);
             if ((pMac->ft.ftSmeContext.auth_ft_ies) && 
                     (pMac->ft.ftSmeContext.auth_ft_ies_length))
             {
@@ -182,7 +183,7 @@ void sme_SetFTIEs( tHalHandle hHal, tANI_U8 sessionId, const tANI_U8 *ft_ies,
                 vos_mem_free(pMac->ft.ftSmeContext.auth_ft_ies);
                 pMac->ft.ftSmeContext.auth_ft_ies_length = 0; 
             }
-
+			ft_ies_length = VOS_MIN(ft_ies_length, MAX_FTIE_SIZE);
             // Save the FT IEs
             pMac->ft.ftSmeContext.auth_ft_ies = vos_mem_malloc(ft_ies_length);
             if(pMac->ft.ftSmeContext.auth_ft_ies == NULL)
@@ -198,9 +199,6 @@ void sme_SetFTIEs( tHalHandle hHal, tANI_U8 sessionId, const tANI_U8 *ft_ies,
                 
             pMac->ft.ftSmeContext.FTState = eFT_AUTH_REQ_READY;
 
-#if defined WLAN_FEATURE_VOWIFI_11R_DEBUG
-            smsLog( pMac, LOG1, "ft_ies_length=%d", ft_ies_length);
-#endif
             break;
 
         case eFT_AUTH_COMPLETE:
