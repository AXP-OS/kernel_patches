From 014ca2736795d56f59c46d1e81e9f910caf827b2 Mon Sep 17 00:00:00 2001
From: Deeksha Gupta <deegupta@codeaurora.org>
Date: Thu, 14 Oct 2021 16:23:01 +0530
Subject: [PATCH] wlan: Fix possible OOB in UnpackTlvCore

Currently in UnpackTlvCore(), nBufRemaining is validated
after calling framesntohs API. Since, framesntohs() copies
pIn address to pOut address with length = 2 bytes as below.
DOT11F_MEMCPY(pCtx, (uint16_t *)pOut, pIn, 2);
which could cause OOB issue if pIn contains less than 2 bytes.

Fix is to validate the nBufRemaining size before calling
framesntohs().

Isuse: SEC-3387
Change-Id: I192dd5b0c68813d01b47011f490d6099049bcda3
CRs-Fixed: 3056532
(cherry picked from commit d2a6e223866ca0de9af3fad7a2ad7a44658f479d)
---
 drivers/staging/prima/CORE/BAP/src/btampHCI.c | 28 ++++++++++++++++++-
 1 file changed, 27 insertions(+), 1 deletion(-)

diff --git a/drivers/staging/prima/CORE/BAP/src/btampHCI.c b/drivers/staging/prima/CORE/BAP/src/btampHCI.c
index 0c6d85e44cb2..651908ad475d 100644
--- a/drivers/staging/prima/CORE/BAP/src/btampHCI.c
+++ b/drivers/staging/prima/CORE/BAP/src/btampHCI.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2012-2013 The Linux Foundation. All rights reserved.
+ * Copyright (c) 2012-2013, 2021 The Linux Foundation. All rights reserved.
  *
  * Previously licensed under the ISC license by Qualcomm Atheros, Inc.
  *
@@ -2873,10 +2873,36 @@ static v_U32_t UnpackTlvCore( void *   pCtx,
         else { 
             id = *pBufRemaining; 
         }
+        if ( sType > nBufRemaining )
+        {
+            FRAMES_LOG0( pCtx, FRLOGE, FRFL( "This frame reports "
+                         "fewer sType byte(s) remaining.\n" ) );
+            status |= BTAMP_INCOMPLETE_TLV;
+            FRAMES_DBG_BREAK();
+            goto MandatoryCheck;
+        }
         pBufRemaining += sType;
         nBufRemaining -= sType;
         // & length,
+        if ( 2 > nBufRemaining )
+        {
+            FRAMES_LOG0( pCtx, FRLOGE, FRFL( "This frame reports "
+			 "fewer two byte(s) remaining.\n" ) );
+            status |= BTAMP_INCOMPLETE_TLV;
+            FRAMES_DBG_BREAK();
+            goto MandatoryCheck;
+        }
+
         framesntohs(pCtx, &len, pBufRemaining, 1);
+
+        if ( sLen > nBufRemaining )
+        {
+            FRAMES_LOG0( pCtx, FRLOGE, FRFL( "This frame reports "
+			 "fewer sLen byte(s) remaining.\n" ) );
+            status |= BTAMP_INCOMPLETE_TLV;
+            FRAMES_DBG_BREAK();
+            goto MandatoryCheck;
+        }
         pBufRemaining += sLen;
         nBufRemaining -= sLen;
 
