From 36dd3a5a3c4278272cbe2c78392499bee51671c4 Mon Sep 17 00:00:00 2001
From: Li Feng <quic_lifeng@quicinc.com>
Date: Mon, 29 Nov 2021 13:37:40 +0800
Subject: qcacld-2.0: Validate NDP app info length before accessing NDP app
 info

propagation from qcacld-3.0 to qcacld-2.0

Currently, NDP app info length is not being validated with max NDP
app info length. This may result in buffer oveflow wile accessing
NDP app info received from the firmware.

To address this, validate NDP app info length before accessing NDP
app info

Change-Id: If09b0ddd75ff0e72fdd269514677e2b5721e4fc6
CRs-Fixed: 3082341
---
 CORE/HDD/src/wlan_hdd_nan_datapath.c | 2 ++
 CORE/HDD/src/wlan_hdd_nan_datapath.h | 2 +-
 CORE/SERVICES/WMA/wma_nan_datapath.c | 4 ++++
 CORE/SERVICES/WMA/wma_nan_datapath.h | 3 +++
 4 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/CORE/HDD/src/wlan_hdd_nan_datapath.c b/CORE/HDD/src/wlan_hdd_nan_datapath.c
index dc3b768..fa532a2 100644
--- a/CORE/HDD/src/wlan_hdd_nan_datapath.c
+++ b/CORE/HDD/src/wlan_hdd_nan_datapath.c
@@ -1,5 +1,6 @@
 /*
  * Copyright (c) 2016-2020 The Linux Foundation. All rights reserved.
+ * Copyright (c) 2021 Qualcomm Innovation Center, Inc. All rights reserved.
  *
  * Previously licensed under the ISC license by Qualcomm Atheros, Inc.
  *
@@ -34,6 +35,7 @@
 #include "wma_api.h"
 #include "wlan_hdd_assoc.h"
 #include "sme_nan_datapath.h"
+#include "wma_nan_datapath.h"
 
 /* NLA policy */
 const struct nla_policy
diff --git a/CORE/HDD/src/wlan_hdd_nan_datapath.h b/CORE/HDD/src/wlan_hdd_nan_datapath.h
index ab4acee..18de33e 100644
--- a/CORE/HDD/src/wlan_hdd_nan_datapath.h
+++ b/CORE/HDD/src/wlan_hdd_nan_datapath.h
@@ -1,5 +1,6 @@
 /*
  * Copyright (c) 2016, 2020 The Linux Foundation. All rights reserved.
+ * Copyright (c) 2021 Qualcomm Innovation Center, Inc. All rights reserved.
  *
  * Previously licensed under the ISC license by Qualcomm Atheros, Inc.
  *
@@ -37,7 +38,6 @@ struct wireless_dev;
 #define NAN_SOCIAL_CHANNEL_5GHZ_LOWER_BAND 44
 #define NAN_SOCIAL_CHANNEL_5GHZ_UPPER_BAND 149
 
-#define NDP_APP_INFO_LEN 255
 #define NDP_QOS_INFO_LEN 255
 #define NDP_PMK_LEN 32
 #define NDP_SCID_BUF_LEN 256
diff --git a/CORE/SERVICES/WMA/wma_nan_datapath.c b/CORE/SERVICES/WMA/wma_nan_datapath.c
index 725049c..9aad66f 100644
--- a/CORE/SERVICES/WMA/wma_nan_datapath.c
+++ b/CORE/SERVICES/WMA/wma_nan_datapath.c
@@ -1,5 +1,6 @@
 /*
  * Copyright (c) 2016-2019 The Linux Foundation. All rights reserved.
+ * Copyright (c) 2021 Qualcomm Innovation Center, Inc. All rights reserved.
  *
  * Previously licensed under the ISC license by Qualcomm Atheros, Inc.
  *
@@ -723,6 +724,9 @@ static int wma_ndp_confirm_event_handler(void *handle, uint8_t *event_info,
 				   ndp_confirm->peer_ndi_mac_addr.bytes);
 
 	ndp_confirm->ndp_info.ndp_app_info_len = fixed_params->ndp_app_info_len;
+	if (ndp_confirm->ndp_info.ndp_app_info_len > NDP_APP_INFO_LEN)
+		ndp_confirm->ndp_info.ndp_app_info_len = NDP_APP_INFO_LEN;
+
 	if (ndp_confirm->ndp_info.ndp_app_info_len > event->num_ndp_app_info) {
 		WMA_LOGE(FL("Invalid ndp_app_info_len: %d"),
 			ndp_confirm->ndp_info.ndp_app_info_len);
diff --git a/CORE/SERVICES/WMA/wma_nan_datapath.h b/CORE/SERVICES/WMA/wma_nan_datapath.h
index ba78743..1d9ae87 100644
--- a/CORE/SERVICES/WMA/wma_nan_datapath.h
+++ b/CORE/SERVICES/WMA/wma_nan_datapath.h
@@ -1,5 +1,6 @@
 /*
  * Copyright (c) 2016 The Linux Foundation. All rights reserved.
+ * Copyright (c) 2021 Qualcomm Innovation Center, Inc. All rights reserved.
  *
  * Previously licensed under the ISC license by Qualcomm Atheros, Inc.
  *
@@ -31,6 +32,8 @@
 #include "sirApi.h"
 #include "sme_nan_datapath.h"
 
+#define NDP_APP_INFO_LEN 255
+
 #ifdef WLAN_FEATURE_NAN_DATAPATH
 #define WMA_IS_VDEV_IN_NDI_MODE(intf, vdev_id) \
 				(WMI_VDEV_TYPE_NDI == intf[vdev_id].type)
-- 
cgit v1.1

