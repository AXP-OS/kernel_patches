From bec4be828440e4584aad0ab7a5f43a40da6b4bd8 Mon Sep 17 00:00:00 2001
From: Akhil P Oommen <quic_akhilpo@quicinc.com>
Date: Mon, 4 Apr 2022 15:52:48 +0530
Subject: [PATCH] msm: kgsl: Fix corruption in kgsl_drawobj_cmd

Fix the below poison corruption:

=============================================================================
kmalloc-256 (Tainted: G S      W  O     ): Poison overwritten
-----------------------------------------------------------------------------
INFO: 0xffffff880b70fda4-0xffffff880b70fda4 @offset=32164. First byte 0x6c instead of 0x6b
INFO: Allocated in kgsl_drawobj_cmd_create+0x48/0x1bc [msm_kgsl] age=4517 cpu=6 pid=29116
	kgsl_drawobj_cmd_create+0x48/0x1bc [msm_kgsl]
	kgsl_ioctl_gpu_command+0x11c/0x340 [msm_kgsl]
	kgsl_ioctl_helper+0x11c/0x208 [msm_kgsl]
	kgsl_ioctl+0x38/0xc0 [msm_kgsl]
	__arm64_sys_ioctl+0x178/0x1fc
	el0_svc_common+0xdc/0x294
	el0_svc+0x38/0x9c
	el0_sync_handler+0x8c/0xf0
	el0_sync+0x1b4/0x1c0
INFO: Freed in cmdobj_destroy_object+0x14/0x24 [msm_kgsl] age=4491 cpu=4 pid=532
	kgsl_drawobj_destroy_object+0x88/0xe4 [msm_kgsl]
	kgsl_drawobj_destroy+0x70/0xec [msm_kgsl]
	dispatcher_handle_jobs_list+0x4ac/0x594 [msm_kgsl]
	adreno_dispatcher_work+0x3bc/0x480 [msm_kgsl]
	kthread_worker_fn+0xf8/0x1d0
	kthread+0x2ac/0x320
	ret_from_fork+0x10/0x30

Change-Id: I8dbe82d428c57881a5e6228c81ad78d4665f3016
Signed-off-by: Akhil P Oommen <quic_akhilpo@quicinc.com>
---
 drivers/gpu/msm/adreno_dispatch.c | 2 +-
 drivers/gpu/msm/adreno_hwsched.c  | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/msm/adreno_dispatch.c b/drivers/gpu/msm/adreno_dispatch.c
index 6ad6db9852fa..ac2e4ec37c58 100644
--- a/drivers/gpu/msm/adreno_dispatch.c
+++ b/drivers/gpu/msm/adreno_dispatch.c
@@ -497,6 +497,7 @@ static inline int adreno_dispatcher_requeue_cmdobj(
 
 	/* Reset the command queue head to reflect the newly requeued change */
 	drawctxt->drawqueue_head = prev;
+	cmdobj->requeue_cnt++;
 	spin_unlock(&drawctxt->lock);
 	return 0;
 }
@@ -787,7 +788,6 @@ static int dispatcher_context_sendcmds(struct adreno_device *adreno_dev,
 					drawctxt, cmdobj);
 				if (r)
 					ret = r;
-				cmdobj->requeue_cnt++;
 			}
 
 			break;
diff --git a/drivers/gpu/msm/adreno_hwsched.c b/drivers/gpu/msm/adreno_hwsched.c
index 85df06a3a6af..6b680c655d11 100644
--- a/drivers/gpu/msm/adreno_hwsched.c
+++ b/drivers/gpu/msm/adreno_hwsched.c
@@ -300,6 +300,7 @@ static inline int hwsched_dispatcher_requeue_cmdobj(
 
 	/* Reset the command queue head to reflect the newly requeued change */
 	drawctxt->drawqueue_head = prev;
+	cmdobj->requeue_cnt++;
 	spin_unlock(&drawctxt->lock);
 	return 0;
 }
@@ -497,7 +498,6 @@ static int hwsched_sendcmds(struct adreno_device *adreno_dev,
 					drawctxt, cmdobj);
 				if (r)
 					ret = r;
-				cmdobj->requeue_cnt++;
 			}
 
 			break;
-- 
GitLab

