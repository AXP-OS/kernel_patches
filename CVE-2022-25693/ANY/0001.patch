From c0d2d03debbedc696561cd7b3c503c4aeaabfa1a Mon Sep 17 00:00:00 2001
From: Kamal Agrawal <quic_kamaagra@quicinc.com>
Date: Sun, 27 Feb 2022 02:21:05 +0530
Subject: [PATCH] msm: kgsl: Fix memory leak in kgsl_ioctl_recurring_command()

Currently, profiling flag for recurring command is cleared after
adding a profiling buffer command object. When command object
destroy is called, it won't put refcount for this profiling buffer
as the flag was cleared earlier resulting in a memory leak. Clear
the profiling flag immediately after draw object creation to avoid
refcount on profiling buffer.

Change-Id: I3b56087d4e18404a19d3ffc429febdf055765f35
Signed-off-by: Kamal Agrawal <quic_kamaagra@quicinc.com>
---
 drivers/gpu/msm/kgsl.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/msm/kgsl.c b/drivers/gpu/msm/kgsl.c
index 3d06db71ae35..09d415bac643 100644
--- a/drivers/gpu/msm/kgsl.c
+++ b/drivers/gpu/msm/kgsl.c
@@ -2259,6 +2259,9 @@ long kgsl_ioctl_recurring_command(struct kgsl_device_private *dev_priv,
 
 	drawobj = DRAWOBJ(cmdobj);
 
+	/* Clear the profiling flag for recurring command */
+	drawobj->flags &= ~(unsigned long)KGSL_DRAWOBJ_PROFILING;
+
 	result = kgsl_drawobj_cmd_add_cmdlist(device, cmdobj,
 		u64_to_user_ptr(param->cmdlist),
 		param->cmdsize, param->numcmds);
@@ -2271,9 +2274,6 @@ long kgsl_ioctl_recurring_command(struct kgsl_device_private *dev_priv,
 	if (result)
 		goto done;
 
-	/* Clear the profiling flag for recurring command */
-	drawobj->flags &= ~(unsigned long)KGSL_DRAWOBJ_PROFILING;
-
 	if (drawobj->flags & KGSL_DRAWOBJ_STOP_RECURRING) {
 		result = device->ftbl->dequeue_recurring_cmd(device, context);
 		if (!result)
-- 
GitLab

