From 704b9257f192bdaa2150bf0d6c263736d09b8600 Mon Sep 17 00:00:00 2001
From: Jianmin Zhu <jianminz@codeaurora.org>
Date: Thu, 30 Sep 2021 15:31:10 +0800
Subject: [PATCH] qcacld-3.0: Fix array OOB for duplicate rate

Some IoT AP may have duplicate rates in supported rates and
extended rates in beacon, need filter them when populate peer 11a/11b
rates during connect/roaming, or array out of bound issue will happen.

Change-Id: I685e8c07ee147296bfa22742dad4210e7fa02c4a
CRs-Fixed: 3048142
---
 core/mac/src/pe/lim/lim_assoc_utils.c | 40 +++++++++++++++------------
 1 file changed, 23 insertions(+), 17 deletions(-)

diff --git a/core/mac/src/pe/lim/lim_assoc_utils.c b/core/mac/src/pe/lim/lim_assoc_utils.c
index 91d94a153e..ebf65cb7fa 100644
--- a/core/mac/src/pe/lim/lim_assoc_utils.c
+++ b/core/mac/src/pe/lim/lim_assoc_utils.c
@@ -1752,7 +1752,6 @@ lim_populate_peer_rate_set(tpAniSirGlobal pMac,
 		for (i = 0; i < tempRateSet.numRates; i++) {
 			min = 0;
 			val = 0xff;
-			isArate = 0;
 			for (j = 0;
 			     (j < tempRateSet.numRates)
 			     && (j < SIR_MAC_RATESET_EID_MAX); j++) {
@@ -1762,31 +1761,38 @@ lim_populate_peer_rate_set(tpAniSirGlobal pMac,
 					min = j;
 				}
 			}
-			if (sirIsArate(tempRateSet.rate[min] & 0x7f))
+			if (sirIsArate(tempRateSet.rate[min] & 0x7f)) {
 				isArate = 1;
+			} else if (sirIsBrate(tempRateSet.rate[min] & 0x7f)) {
+				isArate = 0;
+			} else {
+				pe_debug("%d is neither 11a nor 11b rate",
+					 tempRateSet.rate[min]);
+				tempRateSet.rate[min] = 0xff;
+				continue;
+			}
+			if (tempRateSet.rate[min] == pRates->llaRates[aRateIndex] ||
+			    tempRateSet.rate[min] == pRates->llbRates[bRateIndex]) {
+				pe_debug("Duplicate rate: %d", tempRateSet.rate[min]);
+				tempRateSet.rate[min] = 0xff;
+				continue;
+			}
 			/*
 			 * HAL needs to know whether the rate is basic rate or not, as it needs to
 			 * update the response rate table accordingly. e.g. if one of the 11a rates is
 			 * basic rate, then that rate can be used for sending control frames.
 			 * HAL updates the response rate table whenever basic rate set is changed.
 			 */
-			if (basicOnly) {
-				if (tempRateSet.rate[min] & 0x80) {
-					if (isArate)
-						pRates->llaRates[aRateIndex++] =
-							tempRateSet.rate[min];
-					else
-						pRates->llbRates[bRateIndex++] =
-							tempRateSet.rate[min];
-				}
-			} else {
-				if (isArate)
-					pRates->llaRates[aRateIndex++] =
+			if (basicOnly && !(tempRateSet.rate[min] & 0x80)) {
+				tempRateSet.rate[min] = 0xff;
+				continue;
+			}
+			if (isArate && aRateIndex < SIR_NUM_11A_RATES)
+				pRates->llaRates[aRateIndex++] =
 						tempRateSet.rate[min];
-				else
-					pRates->llbRates[bRateIndex++] =
+			else if (bRateIndex < SIR_NUM_11B_RATES)
+				pRates->llbRates[bRateIndex++] =
 						tempRateSet.rate[min];
-			}
 			tempRateSet.rate[min] = 0xff;
 		}
 	}
-- 
GitLab

