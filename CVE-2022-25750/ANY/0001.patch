From 0f60a0e18af70b029c135555dbdf451efd8242f3 Mon Sep 17 00:00:00 2001
From: Satish Kumar Kodishala <quic_skodisha@quicinc.com>
Date: Tue, 18 Jan 2022 16:12:35 +0530
Subject: [PATCH] BTFMSLIM: Free memory during error while port open

Free memory only during error while opening a port.
In success case, memory will be freed during port
closure.

CRs-Fixed: 3113018
Change-Id: Ice2172c7865e5df5898b3ac927f842db1516fd96
Signed-off-by: Satish Kumar Kodishala <quic_skodisha@quicinc.com>
---
 drivers/bluetooth/btfm_slim.c | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git a/drivers/bluetooth/btfm_slim.c b/drivers/bluetooth/btfm_slim.c
index 6b9a99cbd7b5..e004be558b36 100644
--- a/drivers/bluetooth/btfm_slim.c
+++ b/drivers/bluetooth/btfm_slim.c
@@ -179,9 +179,14 @@ int btfm_slim_enable_ch(struct btfmslim *btfmslim, struct btfmslim_ch *ch,
 
 	if (ret == 0)
 		btfm_num_ports_open++;
-error:
+
 	BTFMSLIM_INFO("btfm_num_ports_open: %d", btfm_num_ports_open);
+	return ret;
+error:
+	BTFMSLIM_INFO("error %d while opening port, btfm_num_ports_open: %d",
+			ret, btfm_num_ports_open);
 	kfree(chan->dai.sconfig.chs);
+	chan->dai.sconfig.chs = NULL;
 	return ret;
 }
 
@@ -241,11 +246,14 @@ int btfm_slim_disable_ch(struct btfmslim *btfmslim, struct btfmslim_ch *ch,
 		}
 	}
 	ch->dai.sconfig.port_mask = 0;
-	kfree(ch->dai.sconfig.chs);
+	if (ch->dai.sconfig.chs != NULL)
+		kfree(ch->dai.sconfig.chs);
 
 	if (btfm_num_ports_open > 0)
 		btfm_num_ports_open--;
 
+	ch->dai.sruntime = NULL;
+
 	BTFMSLIM_INFO("btfm_num_ports_open: %d", btfm_num_ports_open);
 
 	chipset_ver = btpower_get_chipset_version();
-- 
GitLab

