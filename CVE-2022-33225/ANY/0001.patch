From fc511d05a953129da5f685a85afd24af1e279a44 Mon Sep 17 00:00:00 2001
From: wenji <quic_wenji@quicinc.com>
Date: Tue, 24 May 2022 16:36:32 +0800
Subject: [PATCH] mcinvoke : Make sure tzhandle is set before f frees

Make sure tzhandle is set before f frees.

Change-Id: I78d87bb37b22c66b008effc86fe7a2ae25b19b76
Signed-off-by: Wenjie Li <quic_wenji@quicinc.com>
---
 drivers/soc/qcom/smcinvoke.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/soc/qcom/smcinvoke.c b/drivers/soc/qcom/smcinvoke.c
index b99d6133aaea..86a4b7cf57af 100644
--- a/drivers/soc/qcom/smcinvoke.c
+++ b/drivers/soc/qcom/smcinvoke.c
@@ -2,6 +2,7 @@
  * SMC Invoke driver
  *
  * Copyright (c) 2016-2017,2019 The Linux Foundation. All rights reserved.
+ * Copyright (c) 2022 Qualcomm Innovation Center, Inc. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -173,9 +174,9 @@ static int get_fd_from_tzhandle(uint32_t tzhandle, int64_t *fd)
 		goto out;
 
 	*fd = unused_fd;
-	fd_install(*fd, f);
 	((struct smcinvoke_tzobj_context *)
 			(f->private_data))->tzhandle = tzhandle;
+	fd_install(*fd, f);
 	return 0;
 out:
 	if (unused_fd >= 0)
-- 
GitLab

