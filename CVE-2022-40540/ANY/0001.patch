From dae3214cd3495e5c4b37537cacf665d2cdeaea24 Mon Sep 17 00:00:00 2001
From: Murali Nalajala <quic_mnalajal@quicinc.com>
Date: Wed, 7 Sep 2022 17:38:11 -0700
Subject: [PATCH] mdt_loader: check for overflow before allocating memory

Memory allocation is happening without checking the overflow.
This could lead to an unexpected results. Check for overflow
before allocating memory.

Change-Id: Icb513ebd8030976e3f0970e9542596f9c5917843
Signed-off-by: Murali Nalajala <quic_mnalajal@quicinc.com>
---
 drivers/soc/qcom/mdt_loader.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/soc/qcom/mdt_loader.c b/drivers/soc/qcom/mdt_loader.c
index a12d61399e69f..78ef8541a107d 100644
--- a/drivers/soc/qcom/mdt_loader.c
+++ b/drivers/soc/qcom/mdt_loader.c
@@ -139,6 +139,10 @@ void *qcom_mdt_read_metadata(struct device *dev, const struct firmware *fw, cons
 	ehdr_size = phdrs[0].p_filesz;
 	hash_size = phdrs[hash_index].p_filesz;
 
+	/* Overflow check */
+	if (ehdr_size >  SIZE_MAX - hash_size)
+		return ERR_PTR(-ENOMEM);
+
 	/*
 	 * During the scm call memory protection will be enabled for the meta
 	 * data blob, so make sure it's physically contiguous, 4K aligned and
-- 
GitLab

