From f042078c98bae4bc150ae8dc3f46b0c033ba509e Mon Sep 17 00:00:00 2001
From: Mark Zhang <markz@nvidia.com>
Date: Thu, 1 Nov 2018 16:17:29 +0800
Subject: [PATCH] android: sync: Fix information disclosure vulnerability

The format specifier %pP can leak kernel addresses while not valuing the
kptr_restrict system settings.
The fix is designed to use %pK instead of %p, which also evaluates
whether kptr_restrict is set.

Backport to the FP2 kernel 3.4: The FP2 has no NVIDIA components, but
  STS reports the vulnerability that should be fixed by this patch.
  Therefore, this applies equivalent changes to the similar
  drivers/base/sync.c that is present in the tree.

Issue: SEC-1717
Bug: 117423758
Test: addresses in /sys/kernel/debug/sync are all zero now
Change-Id: Ia8427b707e23d274f5565020b444e5fb7f07bfe6
Signed-off-by: Mark Zhang <markz@nvidia.com>
---
 drivers/base/sync.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/base/sync.c b/drivers/base/sync.c
index cf4a1c3ef3b..24fdb709c16 100644
--- a/drivers/base/sync.c
+++ b/drivers/base/sync.c
@@ -629,7 +629,7 @@ void sync_fence_log(struct sync_fence *fence)
 	struct list_head *pos;
 	unsigned long flags;
 
-	pr_info("[%p] %s: %s\n", fence, fence->name,
+	pr_info("[%pK] %s: %s\n", fence, fence->name,
 		sync_status_str(fence->status));
 
 	pr_info("waiters:\n");
@@ -677,14 +677,14 @@ int sync_fence_wait(struct sync_fence *fence, long timeout)
 		return err;
 
 	if (fence->status < 0) {
-		pr_info("fence error %d on [%p]\n", fence->status, fence);
+		pr_info("fence error %d on [%pK]\n", fence->status, fence);
 		sync_fence_log(fence);
 		return fence->status;
 	}
 
 	if (fence->status == 0) {
 		if (timeout > 0) {
-			pr_info("fence timeout on [%p] after %dms\n", fence,
+			pr_info("fence timeout on [%pK] after %dms\n", fence,
 				jiffies_to_msecs(timeout));
 			sync_fence_log(fence);
 		}
@@ -970,7 +970,7 @@ static void sync_print_fence(struct seq_file *s, struct sync_fence *fence)
 	struct list_head *pos;
 	unsigned long flags;
 
-	seq_printf(s, "[%p] %s: %s\n", fence, fence->name,
+	seq_printf(s, "[%pK] %s: %s\n", fence, fence->name,
 		   sync_status_str(fence->status));
 
 	list_for_each(pos, &fence->pt_list_head) {
