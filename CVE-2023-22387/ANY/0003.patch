From b72d8ee2a07cca1a6cfc767b3f4ddc13eb98921c Mon Sep 17 00:00:00 2001
From: Sarannya S <quic_sarannya@quicinc.com>
Date: Wed, 28 Dec 2022 16:31:38 +0530
Subject: [PATCH] net: qrtr: fifo: Add bounds check on tx path

Add bounds check on values read from shared memory in the tx path. In
cases where the VM is misbehaving, the qrtr transport should exit and
print a warning when bogus values may cause out of bounds to be read.

Change-Id: Ic4bdb838ea7f72703327020ec31db2f4150b3474
Signed-off-by: Sarannya S <quic_sarannya@quicinc.com>
---
 net/qrtr/fifo.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/net/qrtr/fifo.c b/net/qrtr/fifo.c
index 6da703791a252..8947363528ec5 100644
--- a/net/qrtr/fifo.c
+++ b/net/qrtr/fifo.c
@@ -125,6 +125,9 @@ static size_t fifo_tx_avail(struct fifo_pipe *pipe)
 	else
 		avail = tail - head;
 
+	if (WARN_ON_ONCE(avail > pipe->length))
+		avail = 0;
+
 	return avail;
 }
 
@@ -135,6 +138,8 @@ static void fifo_tx_write(struct fifo_pipe *pipe,
 	u32 head;
 
 	head = le32_to_cpu(*pipe->head);
+	if (WARN_ON_ONCE(head > pipe->length))
+		return;
 
 	len = min_t(size_t, count, pipe->length - head);
 	if (len)
-- 
GitLab

