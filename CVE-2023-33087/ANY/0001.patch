From 6f62697f7e7d3b777301b79ae4ed4f22527a9696 Mon Sep 17 00:00:00 2001
From: Kaushal Hooda <quic_khooda@quicinc.com>
Date: Mon, 5 Jun 2023 14:14:43 +0530
Subject: [PATCH] rpmsg: slatecom: Discard unaligned packet to read

If intent_alloc_size and chunk size are unaligned with the minimum offset,
then ahb_read can lead to bytes overflow as ahb_read is performed
with word_size aligned.

If the received chunk_size is not aligned to word_size, discard packet
to read.

Change-Id: I36fabc8bde22355de1ae32cb026a2a246778d47e
Signed-off-by: Kaushal Hooda <quic_khooda@quicinc.com>
---
 drivers/rpmsg/qcom_glink_slatecom.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/drivers/rpmsg/qcom_glink_slatecom.c b/drivers/rpmsg/qcom_glink_slatecom.c
index 8543ba9d37458..1d5a3b01bdd2e 100644
--- a/drivers/rpmsg/qcom_glink_slatecom.c
+++ b/drivers/rpmsg/qcom_glink_slatecom.c
@@ -1705,12 +1705,21 @@ static int glink_slatecom_rx_data(struct glink_slatecom *glink,
 
 	if (intent->size - intent->offset < chunk_size) {
 		dev_err(glink->dev, "Insufficient space in intent\n");
+		glink_slatecom_free_intent(channel, intent);
 		mutex_unlock(&channel->intent_lock);
 
 		/* The packet header lied, drop payload */
 		return msglen;
 	}
 
+	if (chunk_size % WORD_SIZE) {
+		dev_err(glink->dev, "For chunk_size %d use short packet\n",
+					chunk_size);
+		glink_slatecom_free_intent(channel, intent);
+		mutex_unlock(&channel->intent_lock);
+		return msglen;
+	}
+
 	do {
 		rc = slatecom_ahb_read(glink->slatecom_handle, (uint32_t)(size_t)addr,
 			ALIGN(chunk_size, WORD_SIZE)/WORD_SIZE,
-- 
GitLab

