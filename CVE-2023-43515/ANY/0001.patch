From 088d55e608c00fe874a1efbb52d754e4490a4ab4 Mon Sep 17 00:00:00 2001
From: Gaurav Kashyap <quic_gaurkash@quicinc.com>
Date: Tue, 20 Dec 2022 16:17:12 -0800
Subject: [PATCH] tmecom: fix integer underflow in tmecom_decode

Fix the integer underflow in tmecom_decode which may
be caused by corner case byte alignment scenarios before
it is called.

Change-Id: I87ad9636718b2a7f39a9e2048777032dd846d35d
Signed-off-by: Gaurav Kashyap <quic_gaurkash@quicinc.com>
---
 drivers/soc/qcom/tmecom/tmecom.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/soc/qcom/tmecom/tmecom.c b/drivers/soc/qcom/tmecom/tmecom.c
index 813f04177873e..4043986eeb9f8 100644
--- a/drivers/soc/qcom/tmecom/tmecom.c
+++ b/drivers/soc/qcom/tmecom/tmecom.c
@@ -147,6 +147,12 @@ int tmecom_process_request(const void *reqbuf, size_t reqsize, void *respbuf,
 	print_hex_dump_bytes("tmecom received bytes : ",
 			DUMP_PREFIX_ADDRESS, tdev->pkt.data, tdev->pkt.size);
 
+	if (tdev->pkt.size <= TMECOM_RX_HDR_SIZE) {
+		dev_err(tdev->dev, "invalid pkt.size received\n");
+		ret = -EPROTO;
+		goto err_exit;
+	}
+
 	*respsize = tmecom_decode(tdev, respbuf);
 
 	tdev->rx_done = false;
-- 
GitLab

