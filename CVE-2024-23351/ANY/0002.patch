From eb7e4fadc904c8134e7d4fc17cae1d2be3ac6368 Mon Sep 17 00:00:00 2001
From: Sanjay Yadav <quic_sanjyada@quicinc.com>
Date: Wed, 22 Nov 2023 13:02:05 +0530
Subject: [PATCH] kgsl: Gen7: Enable access protection for LPAC pipeline

Enable access protection for LPAC pipeline so that command
processor will restrict access to a block of registers from
within the command stream. Any attempt to access protected
register space will result in fault.

Change-Id: Ia8d391f7b9ad1b5d38e7d4d8ac727d2d3f54f53a
Signed-off-by: Hareesh Gundu <quic_hareeshg@quicinc.com>
Signed-off-by: Sanjay Yadav <quic_sanjyada@quicinc.com>
---
 drivers/gpu/msm/adreno_gen7.c | 8 ++++++--
 drivers/gpu/msm/gen7_reg.h    | 1 +
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/msm/adreno_gen7.c b/drivers/gpu/msm/adreno_gen7.c
index 8242d0a410c7e..eb44dc7a550ec 100644
--- a/drivers/gpu/msm/adreno_gen7.c
+++ b/drivers/gpu/msm/adreno_gen7.c
@@ -46,6 +46,7 @@ static const u32 gen7_ifpc_pwrup_reglist[] = {
 	GEN7_TPL1_NC_MODE_CNTL,
 	GEN7_CP_DBG_ECO_CNTL,
 	GEN7_CP_PROTECT_CNTL,
+	GEN7_CP_LPAC_PROTECT_CNTL,
 	GEN7_CP_PROTECT_REG,
 	GEN7_CP_PROTECT_REG+1,
 	GEN7_CP_PROTECT_REG+2,
@@ -220,6 +221,7 @@ int gen7_init(struct adreno_device *adreno_dev)
 		"powerup_register_list");
 }
 
+#define GEN7_PROTECT_DEFAULT (BIT(0) | BIT(1) | BIT(3))
 static void gen7_protect_init(struct adreno_device *adreno_dev)
 {
 	struct kgsl_device *device = KGSL_DEVICE(adreno_dev);
@@ -232,8 +234,10 @@ static void gen7_protect_init(struct adreno_device *adreno_dev)
 	 * protect violation and select the last span to protect from the start
 	 * address all the way to the end of the register address space
 	 */
-	kgsl_regwrite(device, GEN7_CP_PROTECT_CNTL,
-		BIT(0) | BIT(1) | BIT(3));
+	kgsl_regwrite(device, GEN7_CP_PROTECT_CNTL, GEN7_PROTECT_DEFAULT);
+
+	if (adreno_dev->lpac_enabled)
+		kgsl_regwrite(device, GEN7_CP_LPAC_PROTECT_CNTL, GEN7_PROTECT_DEFAULT);
 
 	/* Program each register defined by the core definition */
 	for (i = 0; regs[i].reg; i++) {
diff --git a/drivers/gpu/msm/gen7_reg.h b/drivers/gpu/msm/gen7_reg.h
index d4113c6f8b7da..544a1e01cfb97 100644
--- a/drivers/gpu/msm/gen7_reg.h
+++ b/drivers/gpu/msm/gen7_reg.h
@@ -140,6 +140,7 @@
 #define GEN7_CP_LPAC_RB_BASE_HI          0xb01
 #define GEN7_CP_LPAC_RB_RPTR             0xb06
 #define GEN7_CP_LPAC_RB_WPTR             0xb07
+#define GEN7_CP_LPAC_PROTECT_CNTL        0xb09
 #define GEN7_CP_LPAC_DRAW_STATE_ADDR     0xb0a
 #define GEN7_CP_LPAC_DRAW_STATE_DATA     0xb0b
 #define GEN7_CP_LPAC_ROQ_DBG_ADDR        0xb0c
-- 
GitLab

