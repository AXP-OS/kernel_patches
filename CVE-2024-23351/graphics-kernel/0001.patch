From d7c818d1695cac10489ef1fe28e0d38c602656d9 Mon Sep 17 00:00:00 2001
From: Hareesh Gundu <quic_hareeshg@quicinc.com>
Date: Thu, 26 Oct 2023 16:05:17 -0700
Subject: [PATCH] kgsl: Gen7: Enable access protection for LPAC pipeline

Enable access protection for LPAC pipeline so that command
processor will restrict access to a block of registers from
within the command stream. Any attempt to access protected
register space will result in fault.

Change-Id: Ia8d391f7b9ad1b5d38e7d4d8ac727d2d3f54f53a
Signed-off-by: Hareesh Gundu <quic_hareeshg@quicinc.com>
(cherry picked from commit 28e9ef97b4588094ff15720b334965b37031b58d)
---
 adreno_gen7.c | 9 +++++++--
 gen7_reg.h    | 1 +
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/adreno_gen7.c b/adreno_gen7.c
index 9a63ac3..2b72163 100644
--- a/adreno_gen7.c
+++ b/adreno_gen7.c
@@ -68,6 +68,7 @@ static const u32 gen7_ifpc_pwrup_reglist[] = {
 	GEN7_SP_NC_MODE_CNTL,
 	GEN7_CP_DBG_ECO_CNTL,
 	GEN7_CP_PROTECT_CNTL,
+	GEN7_CP_LPAC_PROTECT_CNTL,
 	GEN7_CP_PROTECT_REG,
 	GEN7_CP_PROTECT_REG+1,
 	GEN7_CP_PROTECT_REG+2,
@@ -123,6 +124,7 @@ static const u32 gen7_0_0_ifpc_pwrup_reglist[] = {
 	GEN7_TPL1_NC_MODE_CNTL,
 	GEN7_CP_DBG_ECO_CNTL,
 	GEN7_CP_PROTECT_CNTL,
+	GEN7_CP_LPAC_PROTECT_CNTL,
 	GEN7_CP_PROTECT_REG,
 	GEN7_CP_PROTECT_REG+1,
 	GEN7_CP_PROTECT_REG+2,
@@ -366,6 +368,7 @@ void gen7_get_gpu_feature_info(struct adreno_device *adreno_dev)
 	adreno_dev->feature_fuse = feature_fuse;
 }
 
+#define GEN7_PROTECT_DEFAULT (BIT(0) | BIT(1) | BIT(3))
 static void gen7_protect_init(struct adreno_device *adreno_dev)
 {
 	struct kgsl_device *device = KGSL_DEVICE(adreno_dev);
@@ -378,8 +381,10 @@ static void gen7_protect_init(struct adreno_device *adreno_dev)
 	 * protect violation and select the last span to protect from the start
 	 * address all the way to the end of the register address space
 	 */
-	kgsl_regwrite(device, GEN7_CP_PROTECT_CNTL,
-		BIT(0) | BIT(1) | BIT(3));
+	kgsl_regwrite(device, GEN7_CP_PROTECT_CNTL, GEN7_PROTECT_DEFAULT);
+
+	if (adreno_dev->lpac_enabled)
+		kgsl_regwrite(device, GEN7_CP_LPAC_PROTECT_CNTL, GEN7_PROTECT_DEFAULT);
 
 	/* Program each register defined by the core definition */
 	for (i = 0; regs[i].reg; i++) {
diff --git a/gen7_reg.h b/gen7_reg.h
index a2af7f0..7f23a0c 100644
--- a/gen7_reg.h
+++ b/gen7_reg.h
@@ -141,6 +141,7 @@
 #define GEN7_CP_LPAC_RB_BASE_HI          0xb01
 #define GEN7_CP_LPAC_RB_RPTR             0xb06
 #define GEN7_CP_LPAC_RB_WPTR             0xb07
+#define GEN7_CP_LPAC_PROTECT_CNTL        0xb09
 #define GEN7_CP_LPAC_DRAW_STATE_ADDR     0xb0a
 #define GEN7_CP_LPAC_DRAW_STATE_DATA     0xb0b
 #define GEN7_CP_LPAC_ROQ_DBG_ADDR        0xb0c
-- 
GitLab

