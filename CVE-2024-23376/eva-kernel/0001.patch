From afb721141cd8a13acd5a0ae5d145746acb9ece5b Mon Sep 17 00:00:00 2001
From: Gopireddy Arunteja Reddy <quic_garuntej@quicinc.com>
Date: Fri, 19 Jan 2024 16:01:19 +0530
Subject: [PATCH] msm: eva: UAF fix in msm_cvp_mark_user_persist

Update buffer ktid inside mutex protetion.

Change-Id: I8c51c4128b4ed58d15f70a2a950bca037fd5ef6c
Signed-off-by: Gopireddy Arunteja Reddy <quic_garuntej@quicinc.com>
---
 msm/eva/msm_cvp_buf.c | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/msm/eva/msm_cvp_buf.c b/msm/eva/msm_cvp_buf.c
index 19a0b66..0694a5b 100644
--- a/msm/eva/msm_cvp_buf.c
+++ b/msm/eva/msm_cvp_buf.c
@@ -1,6 +1,7 @@
 // SPDX-License-Identifier: GPL-2.0-only
 /*
  * Copyright (c) 2020-2021, The Linux Foundation. All rights reserved.
+ * Copyright (c) 2024 Qualcomm Innovation Center, Inc. All rights reserved.
  */
 
 #include <linux/pid.h>
@@ -753,9 +754,10 @@ int msm_cvp_mark_user_persist(struct msm_cvp_inst *inst,
 		list_for_each_entry_safe(pbuf, dummy, &inst->persistbufs.list,
 				list) {
 			if (pbuf->ownership == CLIENT) {
-				if (pbuf->fd == buf->fd &&
-					pbuf->size == buf->size)
+				if (pbuf->fd == buf->fd && pbuf->size == buf->size) {
 					buf->fd = pbuf->smem->device_addr;
+					pbuf->ktid = ktid;
+				}
 				rc = 1;
 				break;
 			}
@@ -767,7 +769,6 @@ int msm_cvp_mark_user_persist(struct msm_cvp_inst *inst,
 			rc = -EFAULT;
 			break;
 		}
-		pbuf->ktid = ktid;
 		rc = 0;
 	}
 	return rc;
-- 
GitLab

