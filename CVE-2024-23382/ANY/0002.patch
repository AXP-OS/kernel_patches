From 90933449f08f0c1df6cecce517fecb4c24cd6b08 Mon Sep 17 00:00:00 2001
From: Sanjay Yadav <quic_sanjyada@quicinc.com>
Date: Tue, 30 Jan 2024 14:48:02 +0530
Subject: [PATCH] msm: kgsl: Call fd_install after creating hw fence

Once fd_install is done, userspace can predict the dma fence fd
and call close(fd). And say the dma fence get signaled at the same time
as well. Then both these operations will reduce the refcount of
the dma fence to zero thereby freeing the kfence. This can cause
use-after-free of the kfence in the hardware fence creation path.
To avoid this, do fd_install after creating hw fence.

Change-Id: Ib9c446562ff5199e469c7db9581518fb5a695e3f
Signed-off-by: Harshdeep Dhatt <quic_hdhatt@quicinc.com>
Signed-off-by: Sanjay Yadav <quic_sanjyada@quicinc.com>
---
 drivers/gpu/msm/kgsl_sync.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/msm/kgsl_sync.c b/drivers/gpu/msm/kgsl_sync.c
index 673357ba44021..2cd728d1506fa 100644
--- a/drivers/gpu/msm/kgsl_sync.c
+++ b/drivers/gpu/msm/kgsl_sync.c
@@ -1,7 +1,7 @@
 // SPDX-License-Identifier: GPL-2.0-only
 /*
  * Copyright (c) 2012-2019, 2021, The Linux Foundation. All rights reserved.
- * Copyright (c) 2022 Qualcomm Innovation Center, Inc. All rights reserved.
+ * Copyright (c) 2022, 2024, Qualcomm Innovation Center, Inc. All rights reserved.
  */
 
 #include <linux/file.h>
@@ -232,11 +232,12 @@ int kgsl_add_fence_event(struct kgsl_device *device,
 		ret = -EFAULT;
 		goto out;
 	}
-	fd_install(priv.fence_fd, kfence->sync_file->file);
 
 	if (!retired)
 		device->ftbl->create_hw_fence(device, kfence);
 
+	fd_install(priv.fence_fd, kfence->sync_file->file);
+
 out:
 	kgsl_context_put(context);
 	if (ret) {
-- 
GitLab

