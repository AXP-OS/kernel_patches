From 67f1a05ec0624ddecbc26a574fca213defcb0e26 Mon Sep 17 00:00:00 2001
From: Harshdeep Dhatt <quic_hdhatt@quicinc.com>
Date: Fri, 12 Jan 2024 12:03:58 -0700
Subject: [PATCH] kgsl: hwfence: Call fd_install after creating hw fence

Once fd_install is done, userspace can predict the dma fence fd
and call close(fd). And say the dma fence get signaled at the same time
as well. Then both these operations will reduce the refcount of
the dma fence to zero thereby freeing the kfence. This can cause
use-after-free of the kfence in the hardware fence creation path.
To avoid this, do fd_install after creating hw fence.

Change-Id: Ib9c446562ff5199e469c7db9581518fb5a695e3f
Signed-off-by: Harshdeep Dhatt <quic_hdhatt@quicinc.com>
(cherry picked from commit 3d2e1fcc74973af233e58127834ad922669c6bf6)
---
 kgsl_sync.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/kgsl_sync.c b/kgsl_sync.c
index 51ea2682..bbfaf1a0 100644
--- a/kgsl_sync.c
+++ b/kgsl_sync.c
@@ -1,7 +1,7 @@
 // SPDX-License-Identifier: GPL-2.0-only
 /*
  * Copyright (c) 2012-2019, 2021, The Linux Foundation. All rights reserved.
- * Copyright (c) 2022-2023, Qualcomm Innovation Center, Inc. All rights reserved.
+ * Copyright (c) 2022-2024, Qualcomm Innovation Center, Inc. All rights reserved.
  */
 
 #include <linux/file.h>
@@ -229,11 +229,12 @@ int kgsl_add_fence_event(struct kgsl_device *device,
 		ret = -EFAULT;
 		goto out;
 	}
-	fd_install(priv.fence_fd, kfence->sync_file->file);
 
 	if (!retired)
 		device->ftbl->create_hw_fence(device, kfence);
 
+	fd_install(priv.fence_fd, kfence->sync_file->file);
+
 out:
 	kgsl_context_put(context);
 	if (ret) {
-- 
GitLab

