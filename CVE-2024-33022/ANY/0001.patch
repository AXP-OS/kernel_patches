From a59577abc48d28601df377e9eaca816eaa2321cd Mon Sep 17 00:00:00 2001
From: juzhan <quic_juzhan@quicinc.com>
Date: Thu, 25 Jan 2024 15:40:44 +0800
Subject: [PATCH] soc: qcom: hgsl: Add the sanity test of UNIT overflow

The addition of params.num_ibs and params.num_allocations may
cause a UNIT overflow, add the sanity test.

Change-Id: I067530e4b3272a5f31742edb256ca8f5c38f2be0
Signed-off-by: juzhan <quic_juzhan@quicinc.com>
(cherry picked from commit a879a34d99beff097dfeeb4e06f7d25cf9e47b85)
---
 drivers/soc/qcom/hgsl/hgsl.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/soc/qcom/hgsl/hgsl.c b/drivers/soc/qcom/hgsl/hgsl.c
index 560fd4cb1b5e0..bd483f3810343 100644
--- a/drivers/soc/qcom/hgsl/hgsl.c
+++ b/drivers/soc/qcom/hgsl/hgsl.c
@@ -2361,6 +2361,12 @@ static int hgsl_ioctl_issueib_with_alloc_list(struct file *filep,
 			}
 		}
 
+		if (params.num_ibs > UINT_MAX - params.num_allocations) {
+			ret = -ENOMEM;
+			LOGE("Too many ibs or allocations: num_ibs = %u, num_allocations = %u",
+				params.num_ibs, params.num_allocations);
+			goto out;
+		}
 		be_data_size = (params.num_ibs + params.num_allocations) *
 			(sizeof(struct gsl_memdesc_t) + sizeof(uint64_t));
 		be_descs = (struct gsl_memdesc_t *)hgsl_malloc(be_data_size);
-- 
GitLab

