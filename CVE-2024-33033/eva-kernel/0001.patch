From 0671810ca16820751715378a97ebc797dff18a89 Mon Sep 17 00:00:00 2001
From: Aniruddh Sharma <quic_anirshar@quicinc.com>
Date: Wed, 27 Dec 2023 18:49:07 +0530
Subject: [PATCH] msm: eva: Fix for use after free

Two threads may enter into race condition if the complete
function is not protected by mutex lock.

Change-Id: I1634ef203aa842eda2239a51f3f6bb1b90c43971
Signed-off-by: Aniruddh Sharma <quic_anirshar@quicinc.com>
---
 msm/eva/msm_cvp_buf.c | 2 --
 1 file changed, 2 deletions(-)

diff --git a/msm/eva/msm_cvp_buf.c b/msm/eva/msm_cvp_buf.c
index 0224742..f3a7876 100644
--- a/msm/eva/msm_cvp_buf.c
+++ b/msm/eva/msm_cvp_buf.c
@@ -652,14 +652,12 @@ int msm_cvp_unmap_buf_wncc(struct msm_cvp_inst *inst,
 			NUM_WNCC_BUFS : inst->unused_wncc_bufs.nr;
 		inst->unused_wncc_bufs.ktid = ++idx % NUM_WNCC_BUFS;
 	}
-	mutex_unlock(&inst->cvpwnccbufs.lock);
 
 	if (cbuf->smem->device_addr) {
 		msm_cvp_unmap_smem(inst, cbuf->smem, "unmap wncc");
 		msm_cvp_smem_put_dma_buf(cbuf->smem->dma_buf);
 	}
 
-	mutex_lock(&inst->cvpwnccbufs.lock);
 	list_del(&cbuf->list);
 	inst->cvpwnccbufs_table[buf_idx].fd = 0;
 	inst->cvpwnccbufs_table[buf_idx].iova = 0;
-- 
GitLab

