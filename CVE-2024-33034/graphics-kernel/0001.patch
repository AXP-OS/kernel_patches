From eb8fa021346f2752cd2dced8dc494c2775aadfd1 Mon Sep 17 00:00:00 2001
From: Lynus Vaz <quic_lvaz@quicinc.com>
Date: Tue, 7 May 2024 12:28:07 -0700
Subject: [PATCH] msm: kgsl: Remove duplicate bind operation code

The bind operation clean up code is duplicated in the worker and the
destroy functions. Instead of doing the same steps at both places, simplify
the code and do the clean up operations only in the destroy function.

Change-Id: I14c9e4f31b40cf6c8062c4427461da3db7d2c097
Signed-off-by: Lynus Vaz <quic_lvaz@quicinc.com>
---
 kgsl_vbo.c | 18 +++++++-----------
 1 file changed, 7 insertions(+), 11 deletions(-)

diff --git a/kgsl_vbo.c b/kgsl_vbo.c
index bf72c139..d27b7de4 100644
--- a/kgsl_vbo.c
+++ b/kgsl_vbo.c
@@ -369,10 +369,13 @@ static void kgsl_sharedmem_free_bind_op(struct kgsl_sharedmem_bind_op *op)
 		/* Decrement the vbo_count we added when creating the bind_op */
 		if (op->ops[i].entry)
 			atomic_dec(&op->ops[i].entry->vbo_count);
-		kgsl_mem_entry_put(op->ops[i].entry);
+
+		/* Release the reference on the child entry */
+		kgsl_mem_entry_put_deferred(op->ops[i].entry);
 	}
 
-	kgsl_mem_entry_put(op->target);
+	/* Release the reference on the target entry */
+	kgsl_mem_entry_put_deferred(op->target);
 
 	kvfree(op->ops);
 	kfree(op);
@@ -559,23 +562,16 @@ static void kgsl_sharedmem_bind_worker(struct work_struct *work)
 				op->ops[i].start,
 				op->ops[i].last,
 				op->ops[i].entry);
-
-		/* Release the reference on the child entry */
-		kgsl_mem_entry_put(op->ops[i].entry);
-		op->ops[i].entry = NULL;
 	}
 
-	/* Release the reference on the target entry */
-	kgsl_mem_entry_put(op->target);
-	op->target = NULL;
-
 	/* Wake up any threads waiting for the bind operation */
 	complete_all(&op->comp);
 
 	if (op->callback)
 		op->callback(op);
 
-	kref_put(&op->ref, kgsl_sharedmem_bind_range_destroy);
+	/* Put the refcount we took when scheduling the worker */
+	kgsl_sharedmem_put_bind_op(op);
 }
 
 void kgsl_sharedmem_bind_ranges(struct kgsl_sharedmem_bind_op *op)
-- 
GitLab

