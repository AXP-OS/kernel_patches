From 0215bbc2e0d7590e324c9d11cc4247304ff65f22 Mon Sep 17 00:00:00 2001
From: Pranay Varma Kopanati <quic_pkopanat@quicinc.com>
Date: Mon, 17 Jun 2024 13:28:38 +0530
Subject: [PATCH] msm: eva: Adding kref count for cvp_get_inst_from_id

Adding count for instance

Change-Id: I4505feb478c1c682ecf6a790d7cb804f70e50a1c
Signed-off-by: Pranay Varma Kopanati <quic_pkopanat@quicinc.com>
---
 drivers/media/platform/msm/cvp/hfi_response_handler.c    | 7 +++++--
 drivers/media/platform/msm/cvp2.0/hfi_response_handler.c | 8 +++++---
 2 files changed, 10 insertions(+), 5 deletions(-)

diff --git a/drivers/media/platform/msm/cvp/hfi_response_handler.c b/drivers/media/platform/msm/cvp/hfi_response_handler.c
index db857c210f3fb..e9d61e3826128 100644
--- a/drivers/media/platform/msm/cvp/hfi_response_handler.c
+++ b/drivers/media/platform/msm/cvp/hfi_response_handler.c
@@ -467,7 +467,7 @@ static struct msm_cvp_inst *cvp_get_inst_from_id(struct msm_cvp_core *core,
 			}
 		}
 
-		inst = match ? inst : NULL;
+		inst = match && kref_get_unless_zero(&inst->kref) ? inst : NULL;
 		mutex_unlock(&core->lock);
 	} else {
 		if (core->state == CVP_CORE_UNINIT)
@@ -519,7 +519,7 @@ static int hfi_process_session_cvp_msg(u32 device_id,
 	sess_msg = kmem_cache_alloc(cvp_driver->msg_cache, GFP_KERNEL);
 	if (sess_msg == NULL) {
 		dprintk(CVP_ERR, "%s runs out msg cache memory\n", __func__);
-		return -ENOMEM;
+		goto error_no_mem;
 	}
 
 	memcpy(&sess_msg->pkt, pkt, get_msg_size(pkt));
@@ -542,11 +542,14 @@ static int hfi_process_session_cvp_msg(u32 device_id,
 
 	info->response_type = HAL_NO_RESP;
 
+	cvp_put_inst(inst);
 	return 0;
 
 error_handle_msg:
 	spin_unlock(&sq->lock);
 	kmem_cache_free(cvp_driver->msg_cache, sess_msg);
+error_no_mem:
+	cvp_put_inst(inst);
 	return -ENOMEM;
 }
 
diff --git a/drivers/media/platform/msm/cvp2.0/hfi_response_handler.c b/drivers/media/platform/msm/cvp2.0/hfi_response_handler.c
index 013232aaa66dc..539779ba2fab4 100644
--- a/drivers/media/platform/msm/cvp2.0/hfi_response_handler.c
+++ b/drivers/media/platform/msm/cvp2.0/hfi_response_handler.c
@@ -427,7 +427,7 @@ static struct msm_cvp_inst *cvp_get_inst_from_id(struct msm_cvp_core *core,
 			}
 		}
 
-		inst = match ? inst : NULL;
+		inst = match && kref_get_unless_zero(&inst->kref) ? inst : NULL;
 		mutex_unlock(&core->lock);
 	} else {
 		if (core->state == CVP_CORE_UNINIT)
@@ -526,7 +526,7 @@ static int hfi_process_session_cvp_msg(u32 device_id,
 	sess_msg = kmem_cache_alloc(cvp_driver->msg_cache, GFP_KERNEL);
 	if (sess_msg == NULL) {
 		dprintk(CVP_ERR, "%s runs out msg cache memory\n", __func__);
-		return -ENOMEM;
+		goto error_no_mem;
 	}
 
 	memcpy(&sess_msg->pkt, pkt, get_msg_size());
@@ -548,12 +548,14 @@ static int hfi_process_session_cvp_msg(u32 device_id,
 	wake_up_all(&inst->session_queue.wq);
 
 	info->response_type = HAL_NO_RESP;
-
+	cvp_put_inst(inst);
 	return 0;
 
 error_handle_msg:
 	spin_unlock(&inst->session_queue.lock);
 	kmem_cache_free(cvp_driver->msg_cache, sess_msg);
+error_no_mem:
+	cvp_put_inst(inst);
 	return -ENOMEM;
 }
 
-- 
GitLab

